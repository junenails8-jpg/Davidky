<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>NEW PROUD NAILS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWAæ”¯æŒ -->
<meta name="description" content="NEW PROUD NAILS - ä¸“ä¸šç¾ç”²æœåŠ¡ï¼Œä½“éªŒä¼˜é›…ä¸ç¾ä¸½">
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NEW PROUD NAILS">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-512.png">

<!-- å¼•å…¥éŸ³æ•ˆé…ç½® -->
<script src="config-sound.js"></script>

<style>
* {
  user-select: none;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-image: 
    linear-gradient(135deg, rgba(102, 126, 234, 0.4) 0%, rgba(118, 75, 162, 0.4) 100%),
    url('glass-bg.jpg');
  background-size: 110% 110%, cover;
  background-position: center center, center center;
  background-attachment: scroll, fixed;
  background-repeat: no-repeat, no-repeat;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  transition: background-position 0.1s ease-out;
  will-change: background-position;
}

/* èŠ‚æ—¥ç‰¹æ•ˆç”»å¸ƒ */
#holidayCanvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
}

/* èŠ‚æ—¥é—®å€™ */
.holiday-greeting {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 255, 0.9);
  padding: 10px 25px;
  border-radius: 20px;
  font-size: 16px;
  font-weight: 700;
  color: #333;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  z-index: 999;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.holiday-greeting.show {
  opacity: 1;
}

/* è¯­è¨€åˆ‡æ¢ */
.language-switcher {
  position: absolute;
  bottom: calc(14% + 200px); /* ä¿®æ”¹ï¼šå¢åŠ è·ç¦»é¿å…ä¸åŠŸèƒ½é”®é‡å  */
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 15px;
  z-index: 998;
  padding: 0 20px;
  transition: transform 0.1s ease-out;
  will-change: transform;
  transform: translateZ(0);
  backface-visibility: hidden;
}

.lang-btn {
  min-width: 90px;
  height: 45px;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 2px solid rgba(255, 255, 255, 0.45);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
  color: rgba(255, 255, 255, 0.95);
  font-size: 15px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lang-btn:hover {
  background: rgba(255, 255, 255, 0.35);
  transform: translateY(-3px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

.lang-btn.active {
  background: rgba(255, 255, 255, 0.5);
  border-color: rgba(255, 255, 255, 0.7);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 2px 8px rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.lang-btn:active {
  transform: translateY(-1px);
}

#logo {
  position: absolute;
  top: 96px;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  text-align: center;
  font-size: clamp(96px, 10vw, 128px);
  font-weight: 800;
  letter-spacing: 3px;
  background: #FF5B5F;
  background-size: cover;
  background-position: center;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent;
  text-shadow: 
    2px 2px 0px rgba(255, 255, 255, 0.4),
    3px 3px 0px rgba(255, 255, 255, 0.3),
    4px 4px 0px rgba(255, 255, 255, 0.2),
    5px 5px 8px rgba(0, 0, 0, 0.08);
  z-index: 2;
  cursor: pointer;
  filter: brightness(1.1) contrast(1.1);
  transition: transform 0.1s ease-out;
  will-change: transform;
  transform: translateX(-50%) translateZ(0);
  backface-visibility: hidden;
}

/* åˆ†æ•°æ˜¾ç¤º */
.score-display {
  position: fixed;
  top: 30px;
  right: 30px;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(15px);
  padding: 15px 25px;
  border-radius: 15px;
  border: 2px solid rgba(255, 255, 255, 0.5);
  z-index: 999;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
}

.music-toggle {
  position: absolute;
  top: 8px;
  left: 8px;
  width: 36px;
  height: 36px;
  border: none;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.3s ease;
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.music-toggle:hover {
  background: rgba(255, 255, 255, 0.4);
  transform: scale(1.1);
}

.music-toggle:active {
  transform: scale(0.95);
}

.music-toggle.muted {
  background: rgba(255, 59, 63, 0.3);
  border-color: rgba(255, 59, 63, 0.5);
}

.score-label {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
  margin-bottom: 5px;
  margin-top: 5px;
}

.score-value {
  font-size: 32px;
  font-weight: 800;
  color: #fff;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.ball-count {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 600;
  margin-top: 2px;
}

/* é¢„çº¦é¢æ¿æ—¶é’Ÿ */
.panel-clock {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 25px;
  text-align: center;
}

.panel-clock-label {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 600;
  margin-bottom: 10px;
}

.panel-clock-time {
  font-size: 36px;
  font-weight: 800;
  color: #fff;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  font-family: 'Courier New', monospace;
  letter-spacing: 3px;
  margin-bottom: 8px;
}

.panel-clock-date {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
}

.light-dot {
  position: absolute;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 3px solid rgba(255, 255, 255, 0.95);
  box-shadow: 0 0 40px rgba(255, 255, 255, 0.95), 0 0 120px rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(4px);
  cursor: pointer;
  z-index: 3;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  top: -100px;
  transition: opacity 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.light-dot.visible { opacity: 1; }
.light-dot.scared { animation: shake 0.3s ease; }

@keyframes shake {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-10deg) scale(0.95); }
  75% { transform: rotate(10deg) scale(0.95); }
}

.face {
  position: relative;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.25);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.eyes {
  display: flex;
  justify-content: space-between;
  width: 100%;
  margin-bottom: 2px;
}

.eye {
  position: relative;
  width: 26px;
  height: 34px;
}

.eye-white {
  width: 100%;
  height: 100%;
  background: #fff;
  border-radius: 50% / 60%;
  border: 1px solid rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.pupil {
  width: 12px;
  height: 12px;
  background: #000;
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  transition: all 0.1s ease;
}

.eye.scared .eye-white {
  width: 120%;
  height: 120%;
  margin-left: -10%;
  margin-top: -10%;
}

.eye.scared .pupil {
  width: 8px;
  height: 8px;
}

.eye.closed .eye-white {
  height: 2px;
  border-radius: 2px;
}

.mouth {
  width: 12px;
  height: 6px;
  border-bottom: 2px solid #000;
  border-radius: 0 0 6px 6px;
  transition: all 0.2s ease;
}

.mouth.scared {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid #000;
}

.speech-bubble {
  position: absolute;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 12px 20px;
  font-size: 18px;
  font-weight: 600;
  color: #FF3B3F;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  z-index: 4;
  opacity: 0;
  transition: opacity 0.5s ease, transform 0.5s ease;
  pointer-events: none;
  transform: translateX(-50%) translateY(-10px);
}

.speech-bubble.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.speech-bubble::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 10px solid rgba(255, 255, 255, 0.95);
}

#buttons {
  position: absolute;
  bottom: 14%;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 20px;
  z-index: 2;
  flex-wrap: wrap;
  padding: 0 20px;
  transition: transform 0.1s ease-out;
  will-change: transform;
  transform: translateX(-50%) translateZ(0);
  backface-visibility: hidden;
}

.glass-btn {
  min-width: 140px;
  height: 60px;
  border-radius: 18px;
  background: rgba(255, 255, 255, 0.28);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.65);
  box-shadow: 0 18px 36px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.35);
  cursor: pointer;
  transition: transform 0.12s ease, box-shadow 0.12s ease;
  position: relative;
  overflow: hidden;
  padding: 0 15px;
}

.glass-btn:active {
  transform: translateY(2px) scale(0.97);
}

.monster-mouth {
  position: absolute;
  width: 0;
  height: 0;
  border-left: 25px solid transparent;
  border-right: 25px solid transparent;
  border-top: 20px solid rgba(139, 0, 0, 0.8);
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  transition: all 0.3s ease;
  opacity: 0;
}

.glass-btn.monster .monster-mouth { opacity: 1; }

.glass-btn.hungry .monster-mouth {
  animation: mouthOpen 0.3s ease forwards;
}

@keyframes mouthOpen {
  0% { border-top-width: 20px; }
  100% { border-top-width: 35px; }
}

.glass-btn.eating .monster-mouth {
  animation: chew 0.4s ease 3;
}

@keyframes chew {
  0%, 100% { border-top-width: 35px; }
  50% { border-top-width: 15px; }
}

.monster-eyes {
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 30px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.glass-btn.monster .monster-eyes { opacity: 1; }

.monster-eye {
  width: 12px;
  height: 12px;
  background: #fff;
  border-radius: 50%;
  position: relative;
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
}

.monster-pupil {
  width: 6px;
  height: 6px;
  background: #000;
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  transition: all 0.2s ease;
}

.glass-btn.hungry .monster-eye {
  animation: eyeExcited 0.3s ease infinite;
}

@keyframes eyeExcited {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.3); }
}

.glass-btn.eating .monster-eye {
  animation: eyeClose 0.4s ease 3;
}

@keyframes eyeClose {
  0%, 100% { height: 12px; }
  50% { height: 2px; }
}

.glass-btn.satisfied .monster-eye {
  height: 2px;
}

.monster-smile {
  position: absolute;
  width: 40px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.9);
  border-top: none;
  border-radius: 0 0 40px 40px;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.glass-btn.satisfied .monster-smile {
  opacity: 1;
}

.glass-btn.gift-transform {
  animation: giftTransform 1.5s ease forwards;
}

@keyframes giftTransform {
  0% { transform: scale(1) rotate(0deg); }
  30% { transform: scale(1.3) rotate(10deg); }
  60% { transform: scale(0.8) rotate(-10deg); }
  100% { transform: scale(20) rotate(360deg); opacity: 0; }
}

#ballCount {
  font-size: 12px;
  margin-left: 5px;
  opacity: 0.9;
}

/* å‡çº§ï¼šä¸åŒé¢œè‰²çš„çƒ */
.glass-ball {
  position: absolute;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(200, 200, 255, 0.4));
  backdrop-filter: blur(8px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), inset -2px -2px 8px rgba(0, 0, 0, 0.2);
  z-index: 5;
  border: 2px solid rgba(255, 255, 255, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 800;
  transition: transform 0.3s ease;
}

/* é‡‘çƒ */
.glass-ball.gold {
  background: radial-gradient(circle at 30% 30%, #FFD700, #FFA500);
  box-shadow: 0 8px 24px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
  animation: goldGlow 1s ease infinite;
}

@keyframes goldGlow {
  0%, 100% { box-shadow: 0 8px 24px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4); }
  50% { box-shadow: 0 8px 24px rgba(255, 215, 0, 0.9), 0 0 40px rgba(255, 215, 0, 0.7); }
}

/* é“¶çƒ */
.glass-ball.silver {
  background: radial-gradient(circle at 30% 30%, #E8E8E8, #C0C0C0);
  box-shadow: 0 8px 24px rgba(192, 192, 192, 0.6), 0 0 20px rgba(192, 192, 192, 0.4);
  animation: silverShine 1.5s ease infinite;
}

@keyframes silverShine {
  0%, 100% { box-shadow: 0 8px 24px rgba(192, 192, 192, 0.6), 0 0 20px rgba(192, 192, 192, 0.4); }
  50% { box-shadow: 0 8px 24px rgba(192, 192, 192, 0.8), 0 0 30px rgba(192, 192, 192, 0.6); }
}

/* æ™®é€šçƒ */
.glass-ball.normal {
  background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(200, 200, 255, 0.4));
}

#promoCard {
  position: absolute;
  width: 90%;
  max-width: 400px;
  height: 250px;
  border-radius: 24px;
  background: linear-gradient(135deg, #FF3B3F, #FF6B6F);
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: #fff;
  cursor: pointer;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  opacity: 0;
  transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.8s ease;
  z-index: 10;
  text-align: center;
  padding: 20px;
}

#promoCard.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.promo-text {
  font-size: 32px;
  margin-bottom: 10px;
}

.promo-subtitle {
  font-size: 18px;
  opacity: 0.9;
}

/* æŠ½å¥–è½®ç›˜ */
.lottery-wheel-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.lottery-wheel-container.show {
  opacity: 1;
  visibility: visible;
}

.lottery-wheel-wrapper {
  position: relative;
  width: 350px;
  height: 450px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.lottery-title {
  font-size: 28px;
  font-weight: 800;
  color: #fff;
  margin-bottom: 20px;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}

.lottery-wheel {
  position: relative;
  width: 320px;
  height: 320px;
  border-radius: 50%;
  border: 8px solid #FFD700;
  box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.wheel-pointer {
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 30px solid #FF3B3F;
  filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.4));
  z-index: 10;
}

.wheel-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #FFD700, #FFA500);
  border-radius: 50%;
  border: 4px solid #fff;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  z-index: 5;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 800;
  color: #fff;
}

.wheel-slice {
  position: absolute;
  width: 50%;
  height: 50%;
  transform-origin: 100% 100%;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding-left: 20px;
  font-size: 13px;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

.spin-button {
  margin-top: 30px;
  padding: 15px 40px;
  background: linear-gradient(135deg, #FF3B3F, #FF6B6F);
  border: none;
  border-radius: 30px;
  color: #fff;
  font-size: 20px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(255, 59, 63, 0.4);
  transition: all 0.3s ease;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.spin-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 25px rgba(255, 59, 63, 0.5);
}

.spin-button:active {
  transform: translateY(-1px);
}

.spin-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.lottery-result {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  background: rgba(255, 255, 255, 0.95);
  padding: 30px 40px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 15;
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.lottery-result.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.result-icon {
  font-size: 60px;
  margin-bottom: 15px;
}

.result-title {
  font-size: 26px;
  font-weight: 800;
  color: #FF3B3F;
  margin-bottom: 10px;
}

.result-desc {
  font-size: 16px;
  color: #666;
  margin-bottom: 20px;
}

.result-close {
  padding: 12px 30px;
  background: #FF3B3F;
  border: none;
  border-radius: 20px;
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
}

.result-close:hover {
  background: #E62B2F;
  transform: translateY(-2px);
}

#fireworkCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9;
  pointer-events: none;
}

/* åŠŸèƒ½é¢æ¿æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼‰ */
.panel-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(6px);
  z-index: 998;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.8s ease, visibility 0.8s ease;
}

.panel-overlay.show {
  opacity: 1;
  visibility: visible;
}

.function-detail-panel {
  position: fixed;
  top: 0;
  left: -100%;
  width: 85%;
  max-width: 600px;
  height: 100%;
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(100px) saturate(300%) brightness(1.15) contrast(1.1);
  -webkit-backdrop-filter: blur(100px) saturate(300%) brightness(1.15) contrast(1.1);
  border-right: 8px solid rgba(255, 255, 255, 0.7);
  border-top: 2px solid rgba(255, 255, 255, 0.4);
  border-bottom: 2px solid rgba(255, 255, 255, 0.4);
  box-shadow: 
    16px 0 120px rgba(0, 0, 0, 0.7),
    12px 0 80px rgba(0, 0, 0, 0.5),
    8px 0 50px rgba(0, 0, 0, 0.4),
    4px 0 25px rgba(0, 0, 0, 0.3),
    inset -4px 0 30px rgba(255, 255, 255, 0.15);
  z-index: 999;
  transition: left 1.5s cubic-bezier(0.16, 0.84, 0.44, 1);
  overflow-y: auto;
  overflow-x: hidden;
}

.function-detail-panel.show {
  left: 0;
  animation: slideInHeavy 1.5s cubic-bezier(0.16, 0.84, 0.44, 1);
}

@keyframes slideInHeavy {
  0% { left: -100%; opacity: 0; transform: translateX(-30px); }
  65% { left: 1%; transform: translateX(0); }
  85% { left: -0.3%; }
  100% { left: 0; opacity: 1; transform: translateX(0); }
}

.function-detail-panel.closing {
  animation: slideOutHeavy 1s cubic-bezier(0.7, 0, 0.84, 0);
}

@keyframes slideOutHeavy {
  0% { left: 0; opacity: 1; transform: translateX(0); }
  100% { left: -100%; opacity: 0; transform: translateX(-30px); }
}

.panel-header {
  position: sticky;
  top: 0;
  background: rgba(255, 255, 255, 0.35);
  backdrop-filter: blur(25px);
  padding: 30px;
  border-bottom: 3px solid rgba(255, 255, 255, 0.5);
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 10;
}

.panel-title {
  font-size: 38px;
  font-weight: 900;
  color: rgba(255, 255, 255, 0.98);
  text-shadow: 0 2px 0 rgba(0, 0, 0, 0.25), 0 5px 12px rgba(0, 0, 0, 0.4);
  letter-spacing: 2px;
}

.panel-close-btn {
  width: 54px;
  height: 54px;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(12px);
  border: 3px solid rgba(255, 255, 255, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 32px;
  color: rgba(255, 255, 255, 0.95);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.panel-close-btn:hover {
  background: rgba(255, 255, 255, 0.5);
  transform: scale(1.15) rotate(90deg);
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.35);
}

.panel-content {
  padding: 40px 30px;
  min-height: calc(100% - 130px);
}

.content-section {
  background: rgba(255, 255, 255, 0.18);
  backdrop-filter: blur(18px);
  border-radius: 22px;
  padding: 32px;
  margin-bottom: 28px;
  border: 2px solid rgba(255, 255, 255, 0.35);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
}

.section-title {
  font-size: 26px;
  font-weight: 800;
  color: rgba(255, 255, 255, 0.98);
  margin-bottom: 18px;
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.35);
}

.section-text {
  font-size: 17px;
  line-height: 1.9;
  color: rgba(255, 255, 255, 0.92);
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.35);
}

.feature-list {
  list-style: none;
  padding: 0;
  margin: 22px 0;
}

.feature-item {
  background: rgba(255, 255, 255, 0.25);
  padding: 17px 22px;
  margin-bottom: 14px;
  border-radius: 14px;
  border-left: 5px solid rgba(255, 255, 255, 0.7);
  color: rgba(255, 255, 255, 0.98);
  font-size: 17px;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.35);
  transition: all 0.3s ease;
}

.feature-item:hover {
  background: rgba(255, 255, 255, 0.35);
  transform: translateX(12px);
}

.action-button {
  width: 100%;
  padding: 20px;
  background: rgba(255, 255, 255, 0.35);
  backdrop-filter: blur(12px);
  border: 3px solid rgba(255, 255, 255, 0.7);
  border-radius: 16px;
  color: rgba(255, 255, 255, 0.98);
  font-size: 19px;
  font-weight: 800;
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.35);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 24px;
}

.action-button:hover {
  background: rgba(255, 255, 255, 0.5);
  transform: translateY(-4px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
}

.action-button:active {
  transform: translateY(-2px);
}

/* ========================================
   å“åº”å¼é€‚é… - æ–°å¢ï¼
   ======================================== */

/* å°æ‰‹æœºï¼ˆiPhone SE, å°å®‰å“æ‰‹æœºï¼‰ */
@media (max-width: 400px) and (max-height: 700px) {
  #logo {
    top: 60px;
    font-size: clamp(70px, 10vw, 90px);
  }
  
  .glass-btn {
    min-width: 110px;
    height: 50px;
    font-size: 14px;
  }
  
  .lang-btn {
    min-width: 70px;
    height: 38px;
    font-size: 13px;
  }
  
  .language-switcher {
    gap: 8px;
    bottom: calc(14% + 70px);
  }
  
  #buttons {
    gap: 12px;
  }
  
  .score-display {
    top: 15px;
    right: 15px;
    padding: 10px 15px;
  }
  
  .score-value {
    font-size: 24px;
  }
}

/* ä¸­ç­‰æ‰‹æœºï¼ˆiPhone 12/13/14æ ‡å‡†ç‰ˆï¼‰ */
@media (min-width: 401px) and (max-width: 430px) and (max-height: 850px) {
  #logo {
    top: 80px;
  }
}

/* å¤§æ‰‹æœºï¼ˆiPhone Pro Max, å¤§å®‰å“æ‰‹æœºï¼‰ */
@media (min-height: 850px) and (max-width: 500px) {
  #logo {
    top: 120px;
    font-size: clamp(110px, 10vw, 140px);
  }
  
  .glass-btn {
    min-width: 150px;
    height: 65px;
    font-size: 17px;
  }
}

/* å¹³æ¿ç«–å± */
@media (min-width: 600px) and (max-width: 900px) {
  #logo {
    top: 100px;
    font-size: 130px;
  }
  
  .glass-btn {
    min-width: 160px;
    height: 70px;
    font-size: 18px;
  }
  
  .lang-btn {
    min-width: 100px;
    height: 50px;
    font-size: 16px;
  }
}

/* å¹³æ¿æ¨ªå± */
@media (min-width: 900px) {
  #logo {
    font-size: 150px;
  }
  
  #buttons {
    gap: 30px;
  }
  
  .glass-btn {
    min-width: 180px;
    height: 75px;
    font-size: 19px;
  }
}

/* è¶…å°å±å¹•ï¼ˆè€æ‰‹æœºï¼‰- æŒ‰é’®ç«–æ’ */
@media (max-width: 360px) {
  #buttons {
    flex-direction: column;
    align-items: center;
    bottom: 10%;
  }
  
  .language-switcher {
    bottom: calc(10% + 280px);
  }
}

/* æ¨ªå±æ¨¡å¼ */
@media (orientation: landscape) and (max-height: 500px) {
  #logo {
    top: 30px;
    font-size: clamp(60px, 8vw, 80px);
  }
  
  #buttons {
    bottom: 5%;
  }
  
  .language-switcher {
    bottom: calc(5% + 80px);
  }
  
  .score-display {
    top: 10px;
    right: 10px;
    padding: 8px 15px;
  }
}

/* iPhoneé™€èºä»ªå¯åŠ¨æŒ‰é’® */
.gyro-permission-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.gyro-permission-overlay.show {
  opacity: 1;
  visibility: visible;
}

.gyro-permission-content {
  text-align: center;
  padding: 40px;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  max-width: 90%;
}

.gyro-permission-title {
  font-size: 28px;
  font-weight: 800;
  color: #fff;
  margin-bottom: 20px;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}

.gyro-permission-text {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 30px;
  line-height: 1.6;
}

.gyro-permission-button {
  padding: 18px 50px;
  background: linear-gradient(135deg, #FF3B3F, #FF6B6F);
  border: none;
  border-radius: 30px;
  color: #fff;
  font-size: 20px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 25px rgba(255, 59, 63, 0.4);
  transition: all 0.3s ease;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.gyro-permission-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 30px rgba(255, 59, 63, 0.5);
}

.gyro-permission-button:active {
  transform: translateY(-1px);
}

/* æ¨ªå±æç¤º */
.landscape-warning {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.landscape-warning.show {
  display: flex;
}

.landscape-icon {
  font-size: 80px;
  margin-bottom: 20px;
  animation: rotate-phone 2s ease-in-out infinite;
}

@keyframes rotate-phone {
  0%, 100% { transform: rotate(0deg); }
  50% { transform: rotate(90deg); }
}

.landscape-text {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  text-align: center;
  padding: 0 30px;
}
</style>
</head>
<body>

<!-- iPhoneé™€èºä»ªæƒé™è¯·æ±‚é®ç½© -->
<div class="gyro-permission-overlay" id="gyroPermission">
  <div class="gyro-permission-content">
    <div class="gyro-permission-title">ğŸ® å¯åŠ¨ä½“æ„Ÿæ•ˆæœ</div>
    <div class="gyro-permission-text">
      å€¾æ–œæ‰‹æœºå¯ä»¥æ§åˆ¶èƒŒæ™¯å’Œçƒçš„ç§»åŠ¨<br>
      ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨ä½“æ„ŸåŠŸèƒ½
    </div>
    <button class="gyro-permission-button" id="enableGyroBtn">å¯åŠ¨ä½“æ„Ÿ</button>
  </div>
</div>

<!-- æ¨ªå±æç¤º -->
<div class="landscape-warning" id="landscapeWarning">
  <div class="landscape-icon">ğŸ“±</div>
  <div class="landscape-text">è¯·ç«–å±ä½¿ç”¨è·å¾—æœ€ä½³ä½“éªŒ</div>
</div>

<!-- èŠ‚æ—¥ç‰¹æ•ˆç”»å¸ƒ -->
<canvas id="holidayCanvas"></canvas>

<!-- èŠ‚æ—¥é—®å€™ -->
<div class="holiday-greeting" id="holidayGreeting"></div>

<!-- é®ç½©å±‚ -->
<div class="panel-overlay" id="panelOverlay" onclick="closeFunctionPanel()"></div>

<!-- åŠŸèƒ½å»¶å±•é¢æ¿ -->
<div class="function-detail-panel" id="functionPanel">
  <div class="panel-header">
    <div class="panel-title" id="panelTitle">é¢„çº¦</div>
    <div class="panel-close-btn" onclick="closeFunctionPanel()">Ã—</div>
  </div>
  <div class="panel-content" id="panelContentArea"></div>
</div>

<!-- åˆ†æ•°æ˜¾ç¤º -->
<div class="score-display">
  <button class="music-toggle" id="musicToggle" onclick="toggleMusic()" title="éŸ³ä¹å¼€å…³">
    <span id="musicIcon">ğŸ”Š</span>
  </button>
  <div class="score-label">Score</div>
  <div class="score-value" id="scoreValue">0</div>
  <div class="ball-count" id="ballCount">(0/20)</div>
</div>

<div id="logo" onclick="playLogoSound()">NEW PROUD NAILS</div>

<div class="light-dot">
  <div class="face">
    <div class="eyes">
      <div class="eye"><div class="eye-white"></div><div class="pupil"></div></div>
      <div class="eye"><div class="eye-white"></div><div class="pupil"></div></div>
    </div>
    <div class="mouth"></div>
  </div>
</div>

<div class="speech-bubble">å“ˆå–½ï¼</div>

<!-- è¯­è¨€åˆ‡æ¢ -->
<div class="language-switcher">
  <button class="lang-btn active" data-lang="zh" onclick="switchLanguage('zh')">ä¸­æ–‡</button>
  <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">English</button>
  <button class="lang-btn" data-lang="es" onclick="switchLanguage('es')">EspaÃ±ol</button>
</div>

<div id="buttons">
  <div class="glass-btn" onclick="clickButton('book')"><span id="btnBook">é¢„çº¦</span></div>
  <div class="glass-btn gift-btn" id="giftBtn">
    <span class="gift-text">
      <span id="btnGiftFull">GIFT</span><span id="ballCount">(0/20)</span>
    </span>
  </div>
  <div class="glass-btn" onclick="clickButton('services')"><span id="btnServices">æœåŠ¡</span></div>
  <div class="glass-btn" onclick="clickButton('member')"><span id="btnMember">ä¼šå‘˜</span></div>
</div>

<div id="promoCard">
  <div class="promo-text">ğŸ æ­å–œï¼</div>
  <div class="promo-subtitle">æ‚¨è·å¾—äº†ä¸“å±ä¼˜æƒ </div>
</div>

<!-- æŠ½å¥–è½®ç›˜ -->
<div class="lottery-wheel-container" id="lotteryContainer">
  <div class="lottery-wheel-wrapper">
    <div class="lottery-title">ğŸŠ Lucky Spin ğŸŠ</div>
    <div style="position: relative;">
      <div class="wheel-pointer"></div>
      <div class="lottery-wheel" id="lotteryWheel">
        <div class="wheel-center">SPIN</div>
      </div>
    </div>
    <button class="spin-button" id="spinButton" onclick="spinWheel()">SPIN NOW!</button>
    
    <div class="lottery-result" id="lotteryResult">
      <div class="result-icon" id="resultIcon">ğŸ‰</div>
      <div class="result-title" id="resultTitle">Congratulations!</div>
      <div class="result-desc" id="resultDesc">You won 10% off!</div>
      <button class="result-close" onclick="closeLottery()">Awesome!</button>
    </div>
  </div>
</div>

<canvas id="fireworkCanvas"></canvas>

<script>
// ========================================
// å…¨å±€å˜é‡
// ========================================
let currentScore = 0;
let totalBalls = 0;
const TARGET_SCORE = 20; // è¾¾åˆ°20åˆ†å¯ä»¥æŠ½å¥–

// ========================================
// éŸ³æ•ˆç®¡ç†ç³»ç»Ÿ
// ========================================
const AudioManager = {
  bgm: null,
  sounds: {},
  voices: {},
  
  init: function() {
    if (typeof ASSETS === 'undefined') {
      console.warn('config-sound.jsæœªåŠ è½½ï¼ŒéŸ³æ•ˆç³»ç»Ÿæœªåˆå§‹åŒ–');
      return;
    }
    
    if (ASSETS.sounds && ASSETS.sounds.bgm) {
      this.bgm = new Audio(ASSETS.sounds.bgm);
      this.bgm.loop = true;
      this.bgm.volume = ASSETS.audioSettings.bgmVolume;
    }
    
    if (ASSETS.sounds) {
      Object.keys(ASSETS.sounds).forEach(key => {
        if (key !== 'bgm' && ASSETS.sounds[key]) {
          this.sounds[key] = new Audio(ASSETS.sounds[key]);
          this.sounds[key].volume = ASSETS.audioSettings.effectVolume;
        }
      });
    }
    
    this.loadVoices(currentLanguage);
  },
  
  loadVoices: function(lang) {
    if (typeof ASSETS === 'undefined' || !ASSETS.languages || !ASSETS.languages[lang]) {
      return;
    }
    
    const voices = ASSETS.languages[lang].voice;
    if (voices) {
      Object.keys(voices).forEach(key => {
        this.voices[key] = new Audio(voices[key]);
        this.voices[key].volume = ASSETS.audioSettings.voiceVolume;
      });
    }
  },
  
  playBGM: function() {
    if (this.bgm && typeof ASSETS !== 'undefined' && ASSETS.audioSettings && ASSETS.audioSettings.enableBGM) {
      this.bgm.play().catch(e => console.log('BGMæ’­æ”¾éœ€è¦ç”¨æˆ·äº¤äº’'));
    }
  },
  
  stopBGM: function() {
    if (this.bgm) {
      this.bgm.pause();
      this.bgm.currentTime = 0;  // é‡ç½®åˆ°å¼€å§‹
    }
  },
  
  stopAllAudio: function() {
    // åœæ­¢èƒŒæ™¯éŸ³ä¹
    if (this.bgm) {
      this.bgm.pause();
      this.bgm.currentTime = 0;
    }
    // åœæ­¢æ‰€æœ‰éŸ³æ•ˆ
    Object.values(this.sounds).forEach(sound => {
      if (sound) {
        sound.pause();
        sound.currentTime = 0;
      }
    });
    // åœæ­¢æ‰€æœ‰è¯­éŸ³
    Object.values(this.voices).forEach(voice => {
      if (voice) {
        voice.pause();
        voice.currentTime = 0;
      }
    });
  },
  
  playSound: function(soundName) {
    if (this.sounds[soundName] && typeof ASSETS !== 'undefined' && ASSETS.audioSettings && ASSETS.audioSettings.enableEffects) {
      this.sounds[soundName].currentTime = 0;
      this.sounds[soundName].play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥'));
    }
  },
  
  playVoice: function(voiceName) {
    if (this.voices[voiceName] && typeof ASSETS !== 'undefined' && ASSETS.audioSettings && ASSETS.audioSettings.enableVoice) {
      this.voices[voiceName].currentTime = 0;
      this.voices[voiceName].play().catch(e => console.log('è¯­éŸ³æ’­æ”¾å¤±è´¥'));
    }
  }
};

// ========================================
// èŠ‚æ—¥ä¸»é¢˜ç³»ç»Ÿ - å‡çº§ç‰ˆï¼è‡ªåŠ¨è®¡ç®—æ„Ÿæ©èŠ‚å’Œå¤æ´»èŠ‚
// ========================================
const HolidayThemes = {
  current: null,
  canvas: null,
  ctx: null,
  particles: [],
  animationId: null,
  
  holidays: {
    newYear: {
      name: { en: 'Happy New Year!', zh: 'æ–°å¹´å¿«ä¹ï¼', es: 'Â¡Feliz AÃ±o Nuevo!' },
      dates: [[1, 1]], // Jan 1
      colors: ['#FFD700', '#FF1493', '#00CED1', '#FF69B4'],
      background: 'linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d)',
      particleType: 'confetti'
    },
    valentine: {
      name: { en: 'Happy Valentine\'s Day!', zh: 'æƒ…äººèŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz San ValentÃ­n!' },
      dates: [[2, 14]], // Feb 14
      colors: ['#FF1493', '#FF69B4', '#FFB6C1'],
      background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      particleType: 'heart'
    },
    easter: {
      name: { en: 'Happy Easter!', zh: 'å¤æ´»èŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz Pascua!' },
      dates: 'calculated', // è‡ªåŠ¨è®¡ç®—
      colors: ['#FFD700', '#87CEEB', '#98FB98', '#FFB6C1'],
      background: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
      particleType: 'egg'
    },
    independence: {
      name: { en: 'Happy 4th of July!', zh: 'ç¾å›½ç‹¬ç«‹æ—¥å¿«ä¹ï¼', es: 'Â¡Feliz 4 de Julio!' },
      dates: [[7, 4]], // July 4
      colors: ['#FF0000', '#FFFFFF', '#0000FF'],
      background: 'linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%)',
      particleType: 'firework'
    },
    halloween: {
      name: { en: 'Happy Halloween!', zh: 'ä¸‡åœ£èŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz Halloween!' },
      dates: [[10, 31]], // Oct 31
      colors: ['#FF6600', '#000000', '#8B008B'],
      background: 'linear-gradient(135deg, #2C003E 0%, #FF6600 100%)',
      particleType: 'pumpkin'
    },
    thanksgiving: {
      name: { en: 'Happy Thanksgiving!', zh: 'æ„Ÿæ©èŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz DÃ­a de AcciÃ³n de Gracias!' },
      dates: 'calculated', // è‡ªåŠ¨è®¡ç®—ï¼š11æœˆç¬¬4ä¸ªæ˜ŸæœŸå››
      colors: ['#FF8C00', '#8B4513', '#FFD700', '#DC143C'],
      background: 'linear-gradient(135deg, #ad5389 0%, #3c1053 100%)',
      particleType: 'leaf'
    },
    christmas: {
      name: { en: 'Merry Christmas!', zh: 'åœ£è¯å¿«ä¹ï¼', es: 'Â¡Feliz Navidad!' },
      dates: [[12, 24], [12, 25], [12, 26]], // Dec 24-26
      colors: ['#FF0000', '#00FF00', '#FFFFFF', '#FFD700'],
      background: 'linear-gradient(135deg, #134E5E 0%, #71B280 100%)',
      particleType: 'snowflake'
    },
    mothersDay: {
      name: { en: 'Happy Mother\'s Day!', zh: 'æ¯äº²èŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz DÃ­a de la Madre!' },
      dates: 'calculated', // 5æœˆç¬¬2ä¸ªæ˜ŸæœŸæ—¥
      colors: ['#FF69B4', '#FFB6C1', '#FFC0CB', '#FFD700'],
      background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      particleType: 'heart'
    },
    fathersDay: {
      name: { en: 'Happy Father\'s Day!', zh: 'çˆ¶äº²èŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz DÃ­a del Padre!' },
      dates: 'calculated', // 6æœˆç¬¬3ä¸ªæ˜ŸæœŸæ—¥
      colors: ['#4169E1', '#1E90FF', '#87CEEB', '#FFD700'],
      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      particleType: 'confetti'
    },
    laborDay: {
      name: { en: 'Happy Labor Day!', zh: 'åŠ³åŠ¨èŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz DÃ­a del Trabajo!' },
      dates: [[5, 1]], // May 1 (International) æˆ– [[9, 1]] for US
      colors: ['#FF0000', '#FFD700', '#FFA500'],
      background: 'linear-gradient(135deg, #f12711 0%, #f5af19 100%)',
      particleType: 'confetti'
    },
    chineseNewYear: {
      name: { en: 'Happy Chinese New Year!', zh: 'æ˜¥èŠ‚å¿«ä¹ï¼', es: 'Â¡Feliz AÃ±o Nuevo Chino!' },
      dates: 'calculated', // è‡ªåŠ¨è®¡ç®—ï¼ˆå†œå†æ­£æœˆåˆä¸€ï¼‰
      colors: ['#FF0000', '#FFD700', '#FF6600'],
      background: 'linear-gradient(135deg, #D31027 0%, #EA384D 100%)',
      particleType: 'firecracker'
    }
  },
  
  // è®¡ç®—æ„Ÿæ©èŠ‚æ—¥æœŸï¼ˆ11æœˆç¬¬4ä¸ªæ˜ŸæœŸå››ï¼‰
  calculateThanksgiving: function(year) {
    // 11æœˆç¬¬4ä¸ªæ˜ŸæœŸå››
    const nov1 = new Date(year, 10, 1); // 10 = November (0-indexed)
    const dayOfWeek = nov1.getDay(); // 0=Sunday, 4=Thursday
    
    // æ‰¾åˆ°11æœˆçš„ç¬¬ä¸€ä¸ªæ˜ŸæœŸå››
    let firstThursday;
    if (dayOfWeek <= 4) {
      // å¦‚æœ11æœˆ1æ—¥æ˜¯å‘¨æ—¥åˆ°å‘¨å››ï¼Œç¬¬ä¸€ä¸ªå‘¨å››å°±åœ¨æœ¬å‘¨
      firstThursday = 1 + (4 - dayOfWeek);
    } else {
      // å¦‚æœ11æœˆ1æ—¥æ˜¯å‘¨äº”æˆ–å‘¨å…­ï¼Œç¬¬ä¸€ä¸ªå‘¨å››åœ¨ä¸‹å‘¨
      firstThursday = 1 + (11 - dayOfWeek);
    }
    
    // ç¬¬4ä¸ªæ˜ŸæœŸå›› = ç¬¬ä¸€ä¸ªæ˜ŸæœŸå›› + 21å¤©
    const thanksgivingDay = firstThursday + 21;
    
    return { month: 11, day: thanksgivingDay };
  },
  
  // è®¡ç®—å¤æ´»èŠ‚æ—¥æœŸï¼ˆä½¿ç”¨é«˜æ–¯ç®—æ³•ï¼‰
  calculateEaster: function(year) {
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const month = Math.floor((h + l - 7 * m + 114) / 31);
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    
    return { month: month, day: day };
  },
  
  // è®¡ç®—å†œå†æ–°å¹´ï¼ˆæ˜¥èŠ‚ï¼‰- 2024-2035å¹´çš„å‡†ç¡®æ—¥æœŸ
  calculateChineseNewYear: function(year) {
    const chineseNewYearDates = {
      2024: { month: 2, day: 10 },
      2025: { month: 1, day: 29 },
      2026: { month: 2, day: 17 },
      2027: { month: 2, day: 6 },
      2028: { month: 1, day: 26 },
      2029: { month: 2, day: 13 },
      2030: { month: 2, day: 3 },
      2031: { month: 1, day: 23 },
      2032: { month: 2, day: 11 },
      2033: { month: 1, day: 31 },
      2034: { month: 2, day: 19 },
      2035: { month: 2, day: 8 }
    };
    
    return chineseNewYearDates[year] || null;
  },
  
  // è®¡ç®—æ¯äº²èŠ‚ï¼ˆ5æœˆç¬¬2ä¸ªæ˜ŸæœŸæ—¥ï¼‰
  calculateMothersDay: function(year) {
    const may1 = new Date(year, 4, 1); // 4 = May
    const dayOfWeek = may1.getDay(); // 0=Sunday
    
    // æ‰¾åˆ°5æœˆçš„ç¬¬ä¸€ä¸ªæ˜ŸæœŸæ—¥
    let firstSunday;
    if (dayOfWeek === 0) {
      firstSunday = 1;
    } else {
      firstSunday = 8 - dayOfWeek;
    }
    
    // ç¬¬2ä¸ªæ˜ŸæœŸæ—¥
    const mothersDayDate = firstSunday + 7;
    
    return { month: 5, day: mothersDayDate };
  },
  
  // è®¡ç®—çˆ¶äº²èŠ‚ï¼ˆ6æœˆç¬¬3ä¸ªæ˜ŸæœŸæ—¥ï¼‰
  calculateFathersDay: function(year) {
    const june1 = new Date(year, 5, 1); // 5 = June
    const dayOfWeek = june1.getDay(); // 0=Sunday
    
    // æ‰¾åˆ°6æœˆçš„ç¬¬ä¸€ä¸ªæ˜ŸæœŸæ—¥
    let firstSunday;
    if (dayOfWeek === 0) {
      firstSunday = 1;
    } else {
      firstSunday = 8 - dayOfWeek;
    }
    
    // ç¬¬3ä¸ªæ˜ŸæœŸæ—¥
    const fathersDayDate = firstSunday + 14;
    
    return { month: 6, day: fathersDayDate };
  },
  
  init: function() {
    this.canvas = document.getElementById('holidayCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
    
    window.addEventListener('resize', () => {
      this.canvas.width = window.innerWidth;
      this.canvas.height = window.innerHeight;
    });
    
    this.checkHoliday();
  },
  
  checkHoliday: function() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    
    // è®¡ç®—åŠ¨æ€èŠ‚æ—¥æ—¥æœŸ
    const thanksgiving = this.calculateThanksgiving(year);
    const easter = this.calculateEaster(year);
    const chineseNewYear = this.calculateChineseNewYear(year);
    const mothersDay = this.calculateMothersDay(year);
    const fathersDay = this.calculateFathersDay(year);
    
    for (const [key, holiday] of Object.entries(this.holidays)) {
      // å¤„ç†éœ€è¦è‡ªåŠ¨è®¡ç®—çš„èŠ‚æ—¥
      if (holiday.dates === 'calculated') {
        let matchDate = null;
        
        if (key === 'thanksgiving') {
          matchDate = thanksgiving;
        } else if (key === 'easter') {
          matchDate = easter;
        } else if (key === 'mothersDay') {
          matchDate = mothersDay;
        } else if (key === 'fathersDay') {
          matchDate = fathersDay;
        } else if (key === 'chineseNewYear') {
          matchDate = chineseNewYear;
        }
        
        if (matchDate) {
          // æ˜¥èŠ‚æ˜¾ç¤º3å¤©ï¼ˆå‰åå„1å¤©ï¼‰ï¼Œå…¶ä»–èŠ‚æ—¥åªæ˜¾ç¤ºå½“å¤©
          if (key === 'chineseNewYear') {
            if (month === matchDate.month && 
                day >= matchDate.day - 1 && 
                day <= matchDate.day + 1) {
              this.applyTheme(holiday);
              return;
            }
          } else {
            if (month === matchDate.month && day === matchDate.day) {
              this.applyTheme(holiday);
              return;
            }
          }
        }
      } else {
        // å¤„ç†å›ºå®šæ—¥æœŸçš„èŠ‚æ—¥
        for (const [m, d] of holiday.dates) {
          if (month === m && day === d) {
            this.applyTheme(holiday);
            return;
          }
        }
      }
    }
  },
  
  applyTheme: function(holiday) {
    this.current = holiday;
    
    // æ›´æ”¹èƒŒæ™¯
    document.body.style.background = holiday.background;
    document.body.style.backgroundSize = '110% 110%';
    
    // æ˜¾ç¤ºèŠ‚æ—¥é—®å€™
    const greeting = document.getElementById('holidayGreeting');
    greeting.textContent = holiday.name[currentLanguage] || holiday.name.en;
    greeting.classList.add('show');
    
    setTimeout(() => {
      greeting.classList.remove('show');
    }, 5000);
    
    // å¼€å§‹ç²’å­æ•ˆæœ
    this.startParticles();
  },
  
  startParticles: function() {
    if (!this.current) return;
    
    const createParticle = () => {
      return {
        x: Math.random() * this.canvas.width,
        y: -20,
        vx: (Math.random() - 0.5) * 2,
        vy: Math.random() * 2 + 1,
        size: Math.random() * 8 + 4,
        color: this.current.colors[Math.floor(Math.random() * this.current.colors.length)],
        rotation: Math.random() * 360,
        rotationSpeed: (Math.random() - 0.5) * 5
      };
    };
    
    // åˆ›å»ºåˆå§‹ç²’å­
    for (let i = 0; i < 30; i++) {
      this.particles.push(createParticle());
    }
    
    const animate = () => {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      
      // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
      this.particles.forEach((p, index) => {
        p.x += p.vx;
        p.y += p.vy;
        p.rotation += p.rotationSpeed;
        
        // ç§»é™¤å‡ºå±å¹•çš„ç²’å­
        if (p.y > this.canvas.height + 20) {
          this.particles.splice(index, 1);
          this.particles.push(createParticle());
        }
        
        // ç»˜åˆ¶ç²’å­
        this.ctx.save();
        this.ctx.translate(p.x, p.y);
        this.ctx.rotate(p.rotation * Math.PI / 180);
        
        if (this.current.particleType === 'snowflake') {
          this.drawSnowflake(p);
        } else if (this.current.particleType === 'heart') {
          this.drawHeart(p);
        } else if (this.current.particleType === 'confetti') {
          this.drawConfetti(p);
        } else {
          this.drawCircle(p);
        }
        
        this.ctx.restore();
      });
      
      this.animationId = requestAnimationFrame(animate);
    };
    
    animate();
  },
  
  drawSnowflake: function(p) {
    this.ctx.fillStyle = p.color;
    this.ctx.beginPath();
    for (let i = 0; i < 6; i++) {
      this.ctx.moveTo(0, 0);
      this.ctx.lineTo(0, -p.size);
      this.ctx.rotate(Math.PI / 3);
    }
    this.ctx.fill();
  },
  
  drawHeart: function(p) {
    this.ctx.fillStyle = p.color;
    this.ctx.beginPath();
    const size = p.size;
    this.ctx.moveTo(0, size / 4);
    this.ctx.bezierCurveTo(size / 2, -size / 2, size, size / 8, 0, size);
    this.ctx.bezierCurveTo(-size, size / 8, -size / 2, -size / 2, 0, size / 4);
    this.ctx.fill();
  },
  
  drawConfetti: function(p) {
    this.ctx.fillStyle = p.color;
    this.ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
  },
  
  drawCircle: function(p) {
    this.ctx.fillStyle = p.color;
    this.ctx.beginPath();
    this.ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
    this.ctx.fill();
  }
};

// ========================================
// æŠ½å¥–è½®ç›˜ç³»ç»Ÿ - æ–°å¢ï¼
// ========================================
const LotteryWheel = {
  prizes: [
    { name: { en: 'Free Hand Care', zh: 'å…è´¹æ‰‹éƒ¨æŠ¤ç†', es: 'Cuidado de Manos Gratis' }, icon: 'ğŸŠ', chance: 5, color: '#FF6B6B' },
    { name: { en: '20% Off', zh: '8æŠ˜ä¼˜æƒ ', es: '20% Descuento' }, icon: 'ğŸ’', chance: 10, color: '#4ECDC4' },
    { name: { en: '15% Off', zh: '8.5æŠ˜ä¼˜æƒ ', es: '15% Descuento' }, icon: 'âœ¨', chance: 20, color: '#95E1D3' },
    { name: { en: '10% Off', zh: '9æŠ˜ä¼˜æƒ ', es: '10% Descuento' }, icon: 'ğŸ’…', chance: 30, color: '#FFE66D' },
    { name: { en: 'Free Nail Stickers', zh: 'å…è´¹ç¾ç”²è´´ç‰‡', es: 'Pegatinas Gratis' }, icon: 'ğŸ', chance: 10, color: '#F38181' },
    { name: { en: 'Friend Referral 50% Off', zh: 'æ¨èæœ‹å‹å„5æŠ˜', es: 'Referir Amigo 50%' }, icon: 'ğŸŒŸ', chance: 5, color: '#AA96DA' },
    { name: { en: 'Free Gift', zh: 'ä¸‹æ¬¡é€å°ç¤¼å“', es: 'Regalo Gratis' }, icon: 'ğŸ’', chance: 15, color: '#FCBAD3' },
    { name: { en: 'Try Again', zh: 'å†æ¥ä¸€æ¬¡', es: 'IntÃ©ntalo de Nuevo' }, icon: 'ğŸ‰', chance: 5, color: '#FFFFD2' }
  ],
  isSpinning: false,
  currentRotation: 0,
  
  init: function() {
    this.createWheel();
  },
  
  createWheel: function() {
    const wheel = document.getElementById('lotteryWheel');
    const totalSlices = this.prizes.length;
    const sliceAngle = 360 / totalSlices;
    
    this.prizes.forEach((prize, index) => {
      const slice = document.createElement('div');
      slice.className = 'wheel-slice';
      slice.style.background = prize.color;
      slice.style.transform = `rotate(${index * sliceAngle}deg) skewY(${90 - sliceAngle}deg)`;
      slice.innerHTML = `${prize.icon} <span style="margin-left: 8px;">${prize.name.en}</span>`;
      wheel.appendChild(slice);
    });
  },
  
  spin: function() {
    if (this.isSpinning) return;
    
    this.isSpinning = true;
    const button = document.getElementById('spinButton');
    button.disabled = true;
    button.textContent = 'Spinning...';
    
    // æ ¹æ®æ¦‚ç‡é€‰æ‹©å¥–å“
    const winner = this.selectWinner();
    const winnerIndex = this.prizes.indexOf(winner);
    const sliceAngle = 360 / this.prizes.length;
    
    // è®¡ç®—ç›®æ ‡è§’åº¦ï¼ˆè®©æŒ‡é’ˆæŒ‡å‘å¥–å“ä¸­å¿ƒï¼‰
    const targetAngle = 360 - (winnerIndex * sliceAngle + sliceAngle / 2);
    const spins = 5; // è½¬5åœˆ
    const finalRotation = spins * 360 + targetAngle;
    
    const wheel = document.getElementById('lotteryWheel');
    wheel.style.transform = `rotate(${finalRotation}deg)`;
    
    setTimeout(() => {
      this.showResult(winner);
      this.isSpinning = false;
      button.disabled = false;
      button.textContent = 'SPIN AGAIN';
      this.currentRotation = finalRotation % 360;
    }, 4000);
  },
  
  selectWinner: function() {
    const totalChance = this.prizes.reduce((sum, p) => sum + p.chance, 0);
    let random = Math.random() * totalChance;
    
    for (const prize of this.prizes) {
      if (random < prize.chance) {
        return prize;
      }
      random -= prize.chance;
    }
    
    return this.prizes[this.prizes.length - 1];
  },
  
  showResult: function(prize) {
    const result = document.getElementById('lotteryResult');
    const icon = document.getElementById('resultIcon');
    const title = document.getElementById('resultTitle');
    const desc = document.getElementById('resultDesc');
    
    icon.textContent = prize.icon;
    title.textContent = 'Congratulations!';
    desc.textContent = `You won: ${prize.name[currentLanguage] || prize.name.en}`;
    
    result.classList.add('show');
    
    // ä¿å­˜æŠ½å¥–è®°å½•ï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰
    const lotteryData = {
      prize: prize.name.en,
      icon: prize.icon,
      timestamp: Date.now()
    };
    try {
      localStorage.setItem('lotteryRecord', JSON.stringify(lotteryData));
    } catch (e) {
      console.log('æ— æ³•ä¿å­˜æŠ½å¥–è®°å½•');
    }
    
    // æ’­æ”¾éŸ³æ•ˆ
    AudioManager.playSound('promoAppear');
  }
};

// æ£€æŸ¥æŠ½å¥–è®°å½•
function checkLotteryRecord() {
  try {
    const record = localStorage.getItem('lotteryRecord');
    if (record) {
      const data = JSON.parse(record);
      const hoursPassed = (Date.now() - data.timestamp) / (1000 * 60 * 60);
      
      if (hoursPassed < 24) {
        // 24å°æ—¶å†…å·²ç»æŠ½è¿‡å¥–
        return {
          hasDrawn: true,
          prize: data.prize,
          icon: data.icon,
          hoursRemaining: Math.ceil(24 - hoursPassed)
        };
      }
    }
  } catch (e) {
    console.log('æ£€æŸ¥æŠ½å¥–è®°å½•å¤±è´¥');
  }
  return { hasDrawn: false };
}

function spinWheel() {
  const record = checkLotteryRecord();
  if (record.hasDrawn) {
    alert(`æ‚¨ä»Šå¤©å·²ç»æŠ½è¿‡å¥–äº†ï¼\nä¸­å¥–ï¼š${record.icon} ${record.prize}\n${record.hoursRemaining}å°æ—¶åå¯ä»¥å†æ¬¡æŠ½å¥–`);
    return;
  }
  LotteryWheel.spin();
}

function showLottery() {
  const record = checkLotteryRecord();
  if (record.hasDrawn) {
    alert(`æ‚¨ä»Šå¤©å·²ç»æŠ½è¿‡å¥–äº†ï¼\nä¸­å¥–ï¼š${record.icon} ${record.prize}\n${record.hoursRemaining}å°æ—¶åå¯ä»¥å†æ¬¡æŠ½å¥–`);
    return;
  }
  
  const container = document.getElementById('lotteryContainer');
  container.classList.add('show');
  AudioManager.playSound('panelSlide');
}

function closeLottery() {
  const container = document.getElementById('lotteryContainer');
  const result = document.getElementById('lotteryResult');
  result.classList.remove('show');
  
  setTimeout(() => {
    container.classList.remove('show');
  }, 300);
}

// ========================================
// éŸ³ä¹æ§åˆ¶ç³»ç»Ÿ
// ========================================
let isMusicMuted = false;

// ä»localStorageè¯»å–éŸ³ä¹çŠ¶æ€
function loadMusicState() {
  try {
    const saved = localStorage.getItem('musicMuted');
    if (saved !== null) {
      isMusicMuted = saved === 'true';
      updateMusicButton();
      if (isMusicMuted) {
        AudioManager.stopBGM();
      }
    }
  } catch (e) {
    console.log('æ— æ³•è¯»å–éŸ³ä¹çŠ¶æ€');
  }
}

// ä¿å­˜éŸ³ä¹çŠ¶æ€åˆ°localStorage
function saveMusicState() {
  try {
    localStorage.setItem('musicMuted', isMusicMuted.toString());
  } catch (e) {
    console.log('æ— æ³•ä¿å­˜éŸ³ä¹çŠ¶æ€');
  }
}

// æ›´æ–°éŸ³ä¹æŒ‰é’®æ˜¾ç¤º
function updateMusicButton() {
  const button = document.getElementById('musicToggle');
  const icon = document.getElementById('musicIcon');
  if (button && icon) {
    if (isMusicMuted) {
      icon.textContent = 'ğŸ”‡';
      button.classList.add('muted');
      button.title = 'ç‚¹å‡»å¼€å¯éŸ³ä¹';
    } else {
      icon.textContent = 'ğŸ”Š';
      button.classList.remove('muted');
      button.title = 'ç‚¹å‡»å…³é—­éŸ³ä¹';
    }
  }
}

// åˆ‡æ¢éŸ³ä¹å¼€å…³
function toggleMusic() {
  isMusicMuted = !isMusicMuted;
  
  if (isMusicMuted) {
    // å…³é—­éŸ³ä¹
    AudioManager.stopBGM();
  } else {
    // å¼€å¯éŸ³ä¹
    AudioManager.playBGM();
  }
  
  updateMusicButton();
  saveMusicState();
}

// é¡µé¢åŠ è½½æ—¶æ¢å¤éŸ³ä¹çŠ¶æ€
window.addEventListener('DOMContentLoaded', () => {
  loadMusicState();
});

// ========================================
// å¤šè¯­è¨€ç³»ç»Ÿ
// ========================================
let currentLanguage = (typeof ASSETS !== 'undefined' && ASSETS.defaultLanguage) ? ASSETS.defaultLanguage : 'en';

function switchLanguage(lang) {
  currentLanguage = lang;
  
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.lang === lang) {
      btn.classList.add('active');
    }
  });
  
  AudioManager.loadVoices(lang);
  updateTexts();
  localStorage.setItem('preferredLanguage', lang);
  
  // ç«‹å³æ›´æ–°é¢„çº¦é¢æ¿æ—¶é’Ÿçš„æ—¥æœŸæ ¼å¼
  updateClock();
  
  // æ›´æ–°èŠ‚æ—¥é—®å€™
  if (HolidayThemes.current) {
    const greeting = document.getElementById('holidayGreeting');
    greeting.textContent = HolidayThemes.current.name[lang];
  }
}

function updateTexts() {
  if (typeof ASSETS === 'undefined' || !ASSETS.languages || !ASSETS.languages[currentLanguage]) {
    return;
  }
  
  const texts = ASSETS.languages[currentLanguage];
  
  document.getElementById('logo').textContent = texts.mainLogo;
  document.querySelector('.speech-bubble').textContent = texts.greeting;
  document.getElementById('btnBook').textContent = texts.buttonBook;
  document.getElementById('btnGiftFull').textContent = texts.buttonGift;
  document.getElementById('btnServices').textContent = texts.buttonServices;
  document.getElementById('btnMember').textContent = texts.buttonMember;
  document.querySelector('.promo-text').textContent = texts.promoTitle;
  document.querySelector('.promo-subtitle').textContent = texts.promoSubtitle;
}

window.addEventListener('DOMContentLoaded', function() {
  AudioManager.init();
  HolidayThemes.init();
  LotteryWheel.init();
  
  // å¯åŠ¨å®æ—¶æ—¶é’Ÿ
  updateClock();
  setInterval(updateClock, 1000);
  
  if (typeof ASSETS !== 'undefined') {
    const savedLang = localStorage.getItem('preferredLanguage');
    if (savedLang && ASSETS.languages && ASSETS.languages[savedLang]) {
      currentLanguage = savedLang;
    } else if (ASSETS.defaultLanguage && ASSETS.languages && ASSETS.languages[ASSETS.defaultLanguage]) {
      currentLanguage = ASSETS.defaultLanguage;
    }
    
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.lang === currentLanguage) {
        btn.classList.add('active');
      }
    });
    
    if (ASSETS.images && ASSETS.images.background) {
      document.body.style.backgroundImage = `url('${ASSETS.images.background}')`;
    }
    
    if (ASSETS.images && ASSETS.images.logoTexture) {
      const logo = document.getElementById('logo');
      logo.style.backgroundImage = `url('${ASSETS.images.logoTexture}')`;
    }
    
    if (ASSETS.colors) {
      document.getElementById('promoCard').style.background = 
        `linear-gradient(135deg, ${ASSETS.colors.primary}, ${ASSETS.colors.secondary})`;
    }
    
    updateTexts();
    AudioManager.playSound('pageLoad');
  } else {
    console.warn('config-sound.jsæœªåŠ è½½ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
  }
});

// ========================================
// å®æ—¶æ—¶é’Ÿç³»ç»Ÿï¼ˆä»…ç”¨äºé¢„çº¦é¢æ¿ï¼‰
// ========================================
function updateClock() {
  const now = new Date();
  
  // æ ¼å¼åŒ–æ—¶é—´
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  const timeString = `${hours}:${minutes}:${seconds}`;
  
  // æ ¼å¼åŒ–æ—¥æœŸ
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const date = now.getDate();
  const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
  const weekday = weekdays[now.getDay()];
  
  let dateString;
  if (currentLanguage === 'zh') {
    dateString = `${year}å¹´${month}æœˆ${date}æ—¥ ${weekday}`;
  } else if (currentLanguage === 'en') {
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const weekdaysEn = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    dateString = `${monthNames[month-1]} ${date}, ${year} ${weekdaysEn[now.getDay()]}`;
  } else if (currentLanguage === 'es') {
    const monthNamesEs = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const weekdaysEs = ['Domingo', 'Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes', 'SÃ¡bado'];
    dateString = `${date} ${monthNamesEs[month-1]} ${year} ${weekdaysEs[now.getDay()]}`;
  }
  
  // åªæ›´æ–°é¢„çº¦é¢æ¿æ—¶é’Ÿ
  const panelClockTime = document.getElementById('panelClockTime');
  const panelClockDate = document.getElementById('panelClockDate');
  if (panelClockTime) panelClockTime.textContent = timeString;
  if (panelClockDate) panelClockDate.textContent = dateString;
}

function playLogoSound() {
  AudioManager.playSound('logoClick');
}

// ========================================
// è§†å·®æ•ˆæœç³»ç»Ÿ
// ========================================
let tiltX = 0, tiltY = 0;

// ç¼“å­˜DOMå…ƒç´ ä»¥æå‡æ€§èƒ½
let parallaxElements = null;

function updateParallax() {
  // é¦–æ¬¡è°ƒç”¨æ—¶ç¼“å­˜å…ƒç´ 
  if (!parallaxElements) {
    parallaxElements = {
      body: document.body,
      logo: document.getElementById('logo'),
      buttons: document.getElementById('buttons'),
      langSwitcher: document.querySelector('.language-switcher')
    };
  }
  
  const bgMoveX = tiltX * 50;
  const bgMoveY = tiltY * 50;
  const logoMoveX = tiltX * 5;
  const logoMoveY = tiltY * 5;
  const btnMoveX = tiltX * 2;
  const btnMoveY = tiltY * 2;
  const langMoveX = tiltX * 3;
  const langMoveY = tiltY * 3;
  
  parallaxElements.body.style.backgroundPosition = `calc(50% + ${bgMoveX}px) calc(50% + ${bgMoveY}px)`;
  
  if (parallaxElements.logo) {
    parallaxElements.logo.style.transform = `translate(calc(-50% + ${logoMoveX}px), ${logoMoveY}px)`;
  }
  
  if (parallaxElements.buttons) {
    parallaxElements.buttons.style.transform = `translate(calc(-50% + ${btnMoveX}px), ${btnMoveY}px)`;
  }
  
  if (parallaxElements.langSwitcher) {
    parallaxElements.langSwitcher.style.transform = `translate(${langMoveX}px, ${langMoveY}px)`;
  }
}

document.addEventListener('mousemove', (e) => {
  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  
  tiltX = (e.clientX - centerX) / centerX * 0.3;
  tiltY = (e.clientY - centerY) / centerY * 0.3;
  
  updateParallax();
});

// ========================================
// åŠŸèƒ½é¢æ¿ç³»ç»Ÿ
// ========================================
const panelContents = {
  zh: {
    book: {
      title: 'ğŸ“… åœ¨çº¿é¢„çº¦',
      sections: [
        { title: 'é¢„çº¦æµç¨‹', text: 'é€‰æ‹©æœåŠ¡ â†’ é€‰æ‹©æ—¶é—´ â†’ ç¡®è®¤é¢„çº¦ â†’ å®Œæˆï¼', features: ['ğŸ’… æŸ¥çœ‹æ‰€æœ‰ç¾ç”²æœåŠ¡é¡¹ç›®', 'ğŸ“… é€‰æ‹©æ‚¨æ–¹ä¾¿çš„æ—¶é—´æ®µ', 'ğŸ‘¤ å¡«å†™æ‚¨çš„è”ç³»æ–¹å¼', 'âœ… å³æ—¶ç¡®è®¤é¢„çº¦æˆåŠŸ'] },
        { title: 'ä¸ºä»€ä¹ˆé€‰æ‹©æˆ‘ä»¬', features: ['ğŸ¨ ä¸“ä¸šç¾ç”²å¸ˆå›¢é˜Ÿ', 'â° çµæ´»çš„é¢„çº¦æ—¶é—´', 'ğŸ’ ä¼˜è´¨çš„æœåŠ¡ä½“éªŒ', 'ğŸ æ–°å®¢ä¸“äº«ä¼˜æƒ '] }
      ],
      action: 'ç«‹å³é¢„çº¦'
    },
    services: {
      title: 'ğŸ’… æœåŠ¡é¡¹ç›®',
      sections: [
        { title: 'ç¾ç”²æœåŠ¡', features: ['âœ¨ ç»å…¸ç¾ç”² - åŸºç¡€æŠ¤ç†ä¸æ¶‚è‰²', 'ğŸ’ æ°´æ™¶ç¾ç”² - æŒä¹…é“ä¸½', 'ğŸ¨ å½©ç»˜ç¾ç”² - ä¸ªæ€§åˆ›æ„', 'ğŸŒ¸ æ—¥å¼ç¾ç”² - ç²¾è‡´ä¼˜é›…', 'ğŸ’« å…‰ç–—ç¾ç”² - è‡ªç„¶å…‰æ³½'] },
        { title: 'ç‰¹è‰²é¡¹ç›®', features: ['ğŸ¦¶ è¶³éƒ¨æŠ¤ç†', 'âœ‹ æ‰‹éƒ¨SPA', 'ğŸ’† æŒ‡ç”²ä¿®å¤', 'ğŸ€ æ–°å¨˜ç¾ç”²'] }
      ],
      action: 'æŸ¥çœ‹ä»·æ ¼'
    },
    member: {
      title: 'ğŸ‘‘ ä¼šå‘˜ä¸­å¿ƒ',
      sections: [
        { title: 'ä¼šå‘˜ç‰¹æƒ', features: ['ğŸ æ¯æœˆç”Ÿæ—¥ç¤¼', 'ğŸ’° ä¸“äº«æŠ˜æ‰£ä¼˜æƒ ', 'â­ ç§¯åˆ†å¥–åŠ±åˆ¶åº¦', 'ğŸ‰ ä¼˜å…ˆé¢„çº¦æƒ', 'ğŸ’ èŠ‚æ—¥ç‰¹åˆ«ç¤¼é‡'] },
        { title: 'ä¼šå‘˜ç­‰çº§', text: 'é“¶å¡ â†’ é‡‘å¡ â†’ é’»çŸ³å¡ï¼Œæ¶ˆè´¹è¶Šå¤šï¼Œç‰¹æƒè¶Šå¤šï¼', features: ['ğŸ¥ˆ é“¶å¡ä¼šå‘˜ - 9.5æŠ˜ä¼˜æƒ ', 'ğŸ¥‡ é‡‘å¡ä¼šå‘˜ - 9æŠ˜ä¼˜æƒ ', 'ğŸ’ é’»çŸ³ä¼šå‘˜ - 8.5æŠ˜ä¼˜æƒ '] }
      ],
      action: 'ç«‹å³å¼€é€š'
    }
  },
  en: {
    book: {
      title: 'ğŸ“… Online Booking',
      sections: [
        { title: 'Booking Process', text: 'Choose Service â†’ Select Time â†’ Confirm â†’ Done!', features: ['ğŸ’… Browse all nail services', 'ğŸ“… Pick your preferred time', 'ğŸ‘¤ Enter your contact info', 'âœ… Instant confirmation'] },
        { title: 'Why Choose Us', features: ['ğŸ¨ Professional nail artists', 'â° Flexible scheduling', 'ğŸ’ Premium service', 'ğŸ New client offers'] }
      ],
      action: 'Book Now'
    },
    services: {
      title: 'ğŸ’… Our Services',
      sections: [
        { title: 'Nail Services', features: ['âœ¨ Classic Manicure', 'ğŸ’ Acrylic Nails', 'ğŸ¨ Nail Art', 'ğŸŒ¸ Japanese Gel', 'ğŸ’« UV Gel Nails'] },
        { title: 'Special Services', features: ['ğŸ¦¶ Pedicure', 'âœ‹ Hand SPA', 'ğŸ’† Nail Repair', 'ğŸ€ Bridal Nails'] }
      ],
      action: 'View Prices'
    },
    member: {
      title: 'ğŸ‘‘ Membership',
      sections: [
        { title: 'Benefits', features: ['ğŸ Birthday gifts', 'ğŸ’° Exclusive discounts', 'â­ Rewards program', 'ğŸ‰ Priority booking', 'ğŸ’ Holiday specials'] },
        { title: 'Tiers', text: 'Silver â†’ Gold â†’ Diamond', features: ['ğŸ¥ˆ Silver - 5% off', 'ğŸ¥‡ Gold - 10% off', 'ğŸ’ Diamond - 15% off'] }
      ],
      action: 'Join Now'
    }
  },
  es: {
    book: {
      title: 'ğŸ“… Reserva Online',
      sections: [
        { title: 'Proceso de Reserva', text: 'Elegir Servicio â†’ Seleccionar Hora â†’ Confirmar â†’ Â¡Listo!', features: ['ğŸ’… Ver todos los servicios', 'ğŸ“… Elegir horario', 'ğŸ‘¤ Ingresar contacto', 'âœ… ConfirmaciÃ³n instantÃ¡nea'] },
        { title: 'Por QuÃ© Elegirnos', features: ['ğŸ¨ Artistas profesionales', 'â° Horarios flexibles', 'ğŸ’ Servicio premium', 'ğŸ Ofertas nuevos clientes'] }
      ],
      action: 'Reservar Ahora'
    },
    services: {
      title: 'ğŸ’… Nuestros Servicios',
      sections: [
        { title: 'Servicios de UÃ±as', features: ['âœ¨ Manicura ClÃ¡sica', 'ğŸ’ UÃ±as AcrÃ­licas', 'ğŸ¨ Nail Art', 'ğŸŒ¸ Gel JaponÃ©s', 'ğŸ’« UÃ±as de Gel UV'] },
        { title: 'Servicios Especiales', features: ['ğŸ¦¶ Pedicura', 'âœ‹ SPA de Manos', 'ğŸ’† ReparaciÃ³n', 'ğŸ€ UÃ±as Nupciales'] }
      ],
      action: 'Ver Precios'
    },
    member: {
      title: 'ğŸ‘‘ Centro de Miembros',
      sections: [
        { title: 'Beneficios', features: ['ğŸ Regalo de cumpleaÃ±os', 'ğŸ’° Descuentos exclusivos', 'â­ Programa de puntos', 'ğŸ‰ Reserva prioritaria', 'ğŸ’ Ofertas especiales'] },
        { title: 'Niveles', text: 'Plata â†’ Oro â†’ Diamante', features: ['ğŸ¥ˆ Plata - 5% descuento', 'ğŸ¥‡ Oro - 10% descuento', 'ğŸ’ Diamante - 15% descuento'] }
      ],
      action: 'Unirse Ahora'
    }
  }
};

function openFunctionPanel(type) {
  const panel = document.getElementById('functionPanel');
  const overlay = document.getElementById('panelOverlay');
  const title = document.getElementById('panelTitle');
  const contentArea = document.getElementById('panelContentArea');
  
  AudioManager.playSound('panelSlide');
  
  const lang = currentLanguage || 'zh';
  const content = panelContents[lang][type];
  
  title.textContent = content.title;
  
  // æ·»åŠ æ—¶é’Ÿæ˜¾ç¤º
  let html = '';
  if (type === 'book') {
    const clockLabel = lang === 'zh' ? 'å½“å‰æ—¶é—´' : (lang === 'en' ? 'Current Time' : 'Hora Actual');
    html += `
      <div class="panel-clock">
        <div class="panel-clock-label">${clockLabel}</div>
        <div class="panel-clock-time" id="panelClockTime">00:00:00</div>
        <div class="panel-clock-date" id="panelClockDate">--</div>
      </div>
    `;
  }
  
  content.sections.forEach(section => {
    html += `<div class="content-section">`;
    html += `<div class="section-title">${section.title}</div>`;
    if (section.text) html += `<div class="section-text">${section.text}</div>`;
    if (section.features) {
      html += `<ul class="feature-list">`;
      section.features.forEach(feature => {
        html += `<li class="feature-item">${feature}</li>`;
      });
      html += `</ul>`;
    }
    html += `</div>`;
  });
  
  html += `<button class="action-button" onclick="alert('åŠŸèƒ½å¼€å‘ä¸­')">${content.action}</button>`;
  
  contentArea.innerHTML = html;
  
  // ç«‹å³æ›´æ–°é¢æ¿ä¸­çš„æ—¶é’Ÿ
  if (type === 'book') {
    updateClock();
  }
  
  overlay.classList.add('show');
  panel.classList.remove('closing');
  panel.classList.add('show');
}

function closeFunctionPanel() {
  const panel = document.getElementById('functionPanel');
  const overlay = document.getElementById('panelOverlay');
  
  panel.classList.add('closing');
  
  setTimeout(() => {
    panel.classList.remove('show', 'closing');
    overlay.classList.remove('show');
  }, 1000);
}

function clickButton(buttonType) {
  AudioManager.playVoice('button' + buttonType.charAt(0).toUpperCase() + buttonType.slice(1));
  setTimeout(() => openFunctionPanel(buttonType), 100);
}

// ========================================
// æ¸¸æˆé€»è¾‘ï¼ˆå‡çº§ç‰ˆï¼‰
// ========================================
const dot = document.querySelector(".light-dot");
const eyes = dot.querySelectorAll(".eye");
const mouth = document.querySelector(".mouth");
const speechBubble = document.querySelector(".speech-bubble");
const giftBtn = document.getElementById("giftBtn");
const ballCountDisplay = document.getElementById("ballCount");
const scoreDisplay = document.getElementById("scoreValue");
const promoCard = document.getElementById("promoCard");
const canvas = document.getElementById("fireworkCanvas");
const ctx = canvas.getContext("2d");

canvas.width = innerWidth;
canvas.height = innerHeight;

const centerX = innerWidth / 2;
const centerY = innerHeight / 2;
const groundY = innerHeight - 150;

let walkTimer, mouseX = centerX, mouseY = centerY;
let clickCount = 0, isScared = false;
let balls = [];

dot.style.left = `${centerX - 30}px`;
dot.style.top = `-100px`;

// ========================================
// iPhoneé™€èºä»ªæƒé™ç³»ç»Ÿ
// ========================================
let gyroPermissionGranted = false;
let deviceOrientationActive = false;

async function requestGyroPermission() {
  const overlay = document.getElementById('gyroPermission');
  const button = document.getElementById('enableGyroBtn');
  
  button.onclick = async () => {
    try {
      // iOS 13+ éœ€è¦è¯·æ±‚æƒé™
      if (typeof DeviceMotionEvent !== 'undefined' && 
          typeof DeviceMotionEvent.requestPermission === 'function') {
        const permission = await DeviceMotionEvent.requestPermission();
        if (permission === 'granted') {
          gyroPermissionGranted = true;
          // ä¿å­˜æƒé™çŠ¶æ€ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰
          try {
            localStorage.setItem('gyroGranted', 'true');
          } catch (e) {
            console.log('æ— æ³•ä¿å­˜é™€èºä»ªæƒé™çŠ¶æ€');
          }
          enableDeviceOrientation();
          overlay.classList.remove('show');
        } else {
          alert('éœ€è¦å…è®¸åŠ¨ä½œå’Œæ–¹å‘æƒé™æ‰èƒ½ä½¿ç”¨ä½“æ„ŸåŠŸèƒ½');
        }
      } else {
        // éiOSæˆ–æ—§ç‰ˆiOSï¼Œç›´æ¥å¯åŠ¨
        gyroPermissionGranted = true;
        try {
          localStorage.setItem('gyroGranted', 'true');
        } catch (e) {
          console.log('æ— æ³•ä¿å­˜é™€èºä»ªæƒé™çŠ¶æ€');
        }
        enableDeviceOrientation();
        overlay.classList.remove('show');
      }
    } catch (error) {
      console.error('é™€èºä»ªæƒé™è¯·æ±‚å¤±è´¥:', error);
      // å°è¯•ç›´æ¥å¯åŠ¨ï¼ˆå¯èƒ½æ˜¯éiOSè®¾å¤‡ï¼‰
      gyroPermissionGranted = true;
      try {
        localStorage.setItem('gyroGranted', 'true');
      } catch (e) {
        console.log('æ— æ³•ä¿å­˜é™€èºä»ªæƒé™çŠ¶æ€');
      }
      enableDeviceOrientation();
      overlay.classList.remove('show');
    }
  };
}

function enableDeviceOrientation() {
  if (deviceOrientationActive) return;
  deviceOrientationActive = true;
  
  let lastUpdateTime = 0;
  const updateInterval = 33; // çº¦30fpsï¼ˆ1000ms / 30 â‰ˆ 33msï¼‰
  let rafId = null;
  let pendingUpdate = false;
  
  window.addEventListener('deviceorientation', (e) => {
    if (e.gamma !== null && e.beta !== null) {
      tiltX = e.gamma / 90;
      tiltY = e.beta / 90;
      
      // ä½¿ç”¨RAFèŠ‚æµï¼Œé¿å…è¿‡åº¦æ›´æ–°
      if (!pendingUpdate) {
        pendingUpdate = true;
        rafId = requestAnimationFrame((timestamp) => {
          const timeSinceLastUpdate = timestamp - lastUpdateTime;
          
          // é™åˆ¶æ›´æ–°é¢‘ç‡åˆ°30fps
          if (timeSinceLastUpdate >= updateInterval) {
            updateParallax();
            lastUpdateTime = timestamp;
          }
          
          pendingUpdate = false;
        });
      }
    }
  });
}

// æ£€æµ‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºæƒé™è¯·æ±‚ï¼ˆä»…iOS 13+ï¼‰
function checkGyroPermissionNeeded() {
  // æ£€æŸ¥æ˜¯å¦å·²ç»æˆæƒè¿‡ï¼ˆè®°å¿†åŠŸèƒ½ - å®‰å…¨æ¨¡å¼ï¼‰
  let savedPermission = null;
  try {
    savedPermission = localStorage.getItem('gyroGranted');
  } catch (e) {
    console.log('æ— æ³•è¯»å–é™€èºä»ªæƒé™çŠ¶æ€');
  }
  
  if (savedPermission === 'true') {
    // å·²ç»æˆæƒè¿‡ï¼Œå°è¯•ç›´æ¥å¯åŠ¨
    try {
      gyroPermissionGranted = true;
      enableDeviceOrientation();
      console.log('é™€èºä»ªè‡ªåŠ¨å¯åŠ¨æˆåŠŸ');
      return; // æˆåŠŸå¯åŠ¨ï¼Œä¸æ˜¾ç¤ºæŒ‰é’®
    } catch (error) {
      // å¯åŠ¨å¤±è´¥ï¼Œæ¸…é™¤è®°å½•å¹¶æ˜¾ç¤ºæŒ‰é’®
      console.log('è‡ªåŠ¨å¯åŠ¨å¤±è´¥ï¼Œéœ€è¦é‡æ–°æˆæƒ');
      try {
        localStorage.removeItem('gyroGranted');
      } catch (e) {
        // å¿½ç•¥æ¸…é™¤å¤±è´¥
      }
    }
  }
  
  // æœªæˆæƒæˆ–è‡ªåŠ¨å¯åŠ¨å¤±è´¥ï¼Œæ˜¾ç¤ºæƒé™è¯·æ±‚æŒ‰é’®
  if (typeof DeviceMotionEvent !== 'undefined' && 
      typeof DeviceMotionEvent.requestPermission === 'function') {
    // iOS 13+ï¼Œéœ€è¦è¯·æ±‚æƒé™
    const overlay = document.getElementById('gyroPermission');
    if (overlay) {
      overlay.classList.add('show');
      requestGyroPermission();
    }
  } else if (window.DeviceOrientationEvent) {
    // éiOSæˆ–æ—§ç‰ˆiOSï¼Œç›´æ¥å¯åŠ¨
    gyroPermissionGranted = true;
    try {
      localStorage.setItem('gyroGranted', 'true');
    } catch (e) {
      console.log('æ— æ³•ä¿å­˜é™€èºä»ªæƒé™çŠ¶æ€');
    }
    enableDeviceOrientation();
  }
}

// ========================================
// æ¨ªå±æ£€æµ‹ç³»ç»Ÿ
// ========================================
function checkOrientation() {
  const warning = document.getElementById('landscapeWarning');
  const isMobile = window.innerWidth < 1024; // åªæ£€æµ‹ç§»åŠ¨è®¾å¤‡
  const isLandscape = window.innerWidth > window.innerHeight;
  
  if (isMobile && isLandscape) {
    // ç§»åŠ¨è®¾å¤‡æ¨ªå±æ—¶æ˜¾ç¤ºæç¤º
    warning.classList.add('show');
  } else {
    warning.classList.remove('show');
  }
}

window.addEventListener('orientationchange', checkOrientation);
window.addEventListener('resize', checkOrientation);

// ========================================
// éŸ³ä¹è‡ªåŠ¨åœæ­¢ç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰
// ========================================
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // é¡µé¢éšè—æ—¶åœæ­¢æ‰€æœ‰éŸ³é¢‘
    AudioManager.stopAllAudio();
  } else {
    // é¡µé¢æ˜¾ç¤ºæ—¶ä¸è‡ªåŠ¨æ’­æ”¾ï¼ˆé¿å…æ‰“æ‰°ç”¨æˆ·ï¼‰
    // å¦‚æœéœ€è¦æ¢å¤éŸ³ä¹ï¼Œå–æ¶ˆæ³¨é‡Šä¸‹é¢è¿™è¡Œï¼š
    // AudioManager.playBGM();
  }
});

// é¡µé¢å¸è½½/å…³é—­æ—¶åœæ­¢æ‰€æœ‰éŸ³é¢‘
window.addEventListener('beforeunload', () => {
  AudioManager.stopAllAudio();
});

// é¡µé¢å¤±å»ç„¦ç‚¹æ—¶åœæ­¢éŸ³é¢‘ï¼ˆé¢å¤–ä¿é™©ï¼‰
window.addEventListener('blur', () => {
  AudioManager.stopAllAudio();
});

// é¡µé¢éšè—æ—¶åœæ­¢éŸ³é¢‘ï¼ˆç§»åŠ¨ç«¯ä¸“ç”¨ï¼‰
window.addEventListener('pagehide', () => {
  AudioManager.stopAllAudio();
});

window.addEventListener('load', () => {
  dot.style.left = `${centerX - 30}px`;
  dot.style.top = `-100px`;
  
  let hasStarted = false;
  
  // æ£€æŸ¥æ¨ªå±
  checkOrientation();
  
  function startEverything() {
    if (hasStarted) return;
    hasStarted = true;
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦é™€èºä»ªæƒé™
    checkGyroPermissionNeeded();
    
    AudioManager.playBGM();
    
    dot.style.transition = 'top 1.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
    dot.style.top = `${centerY - 30}px`;
    dot.classList.add('visible');
    
    AudioManager.playSound('spriteAppear');
    
    setTimeout(() => {
      let greetingText = 'å“ˆå–½ï¼';
      if (typeof ASSETS !== 'undefined' && ASSETS.languages && ASSETS.languages[currentLanguage]) {
        greetingText = ASSETS.languages[currentLanguage].greeting;
      }
      
      showSpeechBubble(greetingText, 3000);
      AudioManager.playVoice('greeting');
      
      startRandomWalk();
      blinkEyes();
    }, 1500);
  }
  
  document.addEventListener('click', startEverything, { once: true });
  document.addEventListener('touchstart', startEverything, { once: true });
});

function showSpeechBubble(text, duration = 3000) {
  const dotRect = dot.getBoundingClientRect();
  speechBubble.textContent = text;
  speechBubble.style.left = `${dotRect.left + dotRect.width / 2}px`;
  speechBubble.style.top = `${dotRect.top - 50}px`;
  speechBubble.classList.add('show');
  setTimeout(() => speechBubble.classList.remove('show'), duration);
}

function updatePupils() {
  eyes.forEach(eye => {
    const pupil = eye.querySelector(".pupil");
    const rect = eye.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    const dx = mouseX - cx;
    const dy = mouseY - cy;
    const max = 10;
    pupil.style.left = 50 + Math.max(-max, Math.min(dx / 10, max)) + "%";
    pupil.style.top = 50 + Math.max(-max, Math.min(dy / 10, max)) + "%";
  });
}

document.addEventListener("mousemove", e => {
  mouseX = e.clientX;
  mouseY = e.clientY;
  updatePupils();
});

document.addEventListener("touchmove", e => {
  if (e.touches.length > 0) {
    mouseX = e.touches[0].clientX;
    mouseY = e.touches[0].clientY;
    updatePupils();
  }
}, { passive: true });

function blinkEyes() {
  eyes.forEach(eye => eye.classList.add("closed"));
  setTimeout(() => eyes.forEach(eye => eye.classList.remove("closed")), 100);
  setTimeout(() => blinkEyes(), 2000 + Math.random() * 3000);
}

function showScaredFace() {
  isScared = true;
  eyes.forEach(eye => eye.classList.add("scared"));
  mouth.classList.add("scared");
  dot.classList.add("scared");
  
  setTimeout(() => {
    eyes.forEach(eye => eye.classList.remove("scared"));
    mouth.classList.remove("scared");
    dot.classList.remove("scared");
    isScared = false;
  }, 800);
}

function startRandomWalk() {
  walkTimer = setInterval(() => {
    if (isScared) return;
    
    let x, y;
    const leaveScreen = Math.random() < 0.2;
    
    if (leaveScreen) {
      const side = Math.floor(Math.random() * 4);
      switch(side) {
        case 0: x = -100; y = Math.random() * innerHeight; break;
        case 1: x = innerWidth + 100; y = Math.random() * innerHeight; break;
        case 2: x = Math.random() * innerWidth; y = -100; break;
        case 3: x = Math.random() * innerWidth; y = innerHeight + 100; break;
      }
      
      dot.style.transition = 'left 2s ease-out, top 2s ease-out';
      dot.style.left = `${x}px`;
      dot.style.top = `${y}px`;
      
      setTimeout(() => {
        const returnX = Math.random() * (innerWidth - 60);
        const returnY = Math.random() * (innerHeight - 200) + 100;
        dot.style.left = `${returnX}px`;
        dot.style.top = `${returnY}px`;
      }, 2500);
    } else {
      x = Math.random() * (innerWidth - 60);
      y = Math.random() * (innerHeight - 200) + 100;
      
      const dx = x - mouseX;
      const dy = y - mouseY;
      const dist = Math.hypot(dx, dy);
      if (dist < 150) {
        x += dx / dist * 100;
        y += dy / dist * 100;
        x = Math.max(0, Math.min(innerWidth - 60, x));
        y = Math.max(0, Math.min(innerHeight - 200, y));
      }
      
      dot.style.transition = 'left 2s ease-out, top 2s ease-out';
      dot.style.left = `${x}px`;
      dot.style.top = `${y}px`;
    }
  }, 3000);
}

function handleDotClick(e) {
  e.preventDefault();
  e.stopPropagation();
  clickCount++;
  
  if (clickCount === 1) {
    showScaredFace();
    AudioManager.playSound('spriteEscape');
    
    const currentX = parseFloat(dot.style.left);
    const currentY = parseFloat(dot.style.top);
    const angle = Math.random() * Math.PI * 2;
    const distance = 150;
    const escapeX = currentX + Math.cos(angle) * distance;
    const escapeY = currentY + Math.sin(angle) * distance;
    
    dot.style.transition = 'left 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), top 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
    dot.style.left = `${Math.max(0, Math.min(innerWidth - 60, escapeX))}px`;
    dot.style.top = `${Math.max(0, Math.min(innerHeight - 200, escapeY))}px`;
    
    setTimeout(() => {
      dot.style.transition = 'left 2s ease-out, top 2s ease-out';
    }, 300);
  } else if (clickCount === 2) {
    showScaredFace();
    AudioManager.playSound('spriteHit');
    dropBall();
    clickCount = 0;
  }
}

dot.addEventListener("touchstart", handleDotClick, { passive: false });
dot.addEventListener("click", handleDotClick);

// å‡çº§ï¼šæ‰è½ä¸åŒç±»å‹çš„çƒ
function dropBall() {
  const rect = dot.getBoundingClientRect();
  const ball = document.createElement("div");
  ball.className = "glass-ball";
  
  // æ ¹æ®æ¦‚ç‡å†³å®šçƒçš„ç±»å‹
  const random = Math.random() * 100;
  let ballType, ballScore;
  
  if (random < 5) { // 5% é‡‘çƒ
    ballType = 'gold';
    ballScore = 3;
    ball.textContent = 'â­';
  } else if (random < 30) { // 25% é“¶çƒ
    ballType = 'silver';
    ballScore = 2;
    ball.textContent = 'âœ¨';
  } else { // 70% æ™®é€šçƒ
    ballType = 'normal';
    ballScore = 1;
    ball.textContent = '';
  }
  
  ball.classList.add(ballType);
  ball.style.left = `${rect.left + rect.width / 2 - 20}px`;
  ball.style.top = `${rect.top + rect.height}px`;
  document.body.appendChild(ball);
  
  const ballObj = {
    element: ball,
    x: rect.left + rect.width / 2 - 20,
    y: rect.top + rect.height,
    vx: (Math.random() - 0.5) * 2,
    vy: 0,
    eaten: false,
    hasPlayedSound: false,
    type: ballType,
    score: ballScore
  };
  balls.push(ballObj);
  animateBall(ballObj);
}

function animateBall(ball) {
  const gravity = 0.5;
  const friction = 0.96;  // å‡å°æ‘©æ“¦åŠ›ï¼Œè®©çƒæ›´å®¹æ˜“æ»šåŠ¨
  const tiltForce = 3.0;  // å¢å¼ºå€¾æ–œåŠ›åº¦
  const bounce = 0.6;
  
  function update() {
    if (ball.eaten) return;
    
    ball.vy += gravity;
    ball.vx += tiltX * tiltForce;
    ball.vy += tiltY * tiltForce * 1.0;  // ä¸Šä¸‹å€¾æ–œå’Œå·¦å³ä¸€æ ·çµæ•
    ball.vx *= friction;
    ball.vy *= friction;
    ball.x += ball.vx;
    ball.y += ball.vy;
    
    if (ball.y >= groundY) {
      ball.y = groundY;
      ball.vy = -ball.vy * bounce;
      if (Math.abs(ball.vy) < 0.5) ball.vy = 0;
      
      if (!ball.hasPlayedSound && Math.abs(ball.vy) > 1) {
        AudioManager.playSound('ballDrop');
        ball.hasPlayedSound = true;
      }
    }
    
    if (ball.x < 0) {
      ball.x = 0;
      ball.vx = -ball.vx * 0.5;
    }
    if (ball.x > innerWidth - 40) {
      ball.x = innerWidth - 40;
      ball.vx = -ball.vx * 0.5;
    }
    
    ball.element.style.left = `${ball.x}px`;
    ball.element.style.top = `${ball.y}px`;
    
    checkGiftCollision(ball);
    
    if (!ball.eaten) requestAnimationFrame(update);
  }
  update();
}

function checkGiftCollision(ball) {
  if (ball.eaten) return;
  
  const giftRect = giftBtn.getBoundingClientRect();
  const ballRect = ball.element.getBoundingClientRect();
  
  const hungryDistance = 100;
  const ballCenterX = ballRect.left + ballRect.width / 2;
  const ballCenterY = ballRect.top + ballRect.height / 2;
  const giftCenterX = giftRect.left + giftRect.width / 2;
  const giftCenterY = giftRect.top + giftRect.height / 2;
  const distance = Math.hypot(ballCenterX - giftCenterX, ballCenterY - giftCenterY);
  
  if (distance < hungryDistance && !giftBtn.classList.contains('hungry') && !giftBtn.classList.contains('eating')) {
    giftBtn.classList.add('hungry');
  } else if (distance >= hungryDistance) {
    giftBtn.classList.remove('hungry');
  }
  
  const overlap = !(
    ballRect.right < giftRect.left ||
    ballRect.left > giftRect.right ||
    ballRect.bottom < giftRect.top ||
    ballRect.top > giftRect.bottom
  );
  
  if (overlap) {
    ball.eaten = true;
    giftBtn.classList.remove('hungry');
    giftBtn.classList.add('eating');
    
    AudioManager.playSound('ballEaten');
    
    ball.element.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
    ball.element.style.transform = 'scale(0) rotate(720deg)';
    ball.element.style.left = `${giftRect.left + giftRect.width / 2 - 20}px`;
    ball.element.style.top = `${giftRect.top + giftRect.height / 2 - 20}px`;
    
    setTimeout(() => {
      ball.element.remove();
      giftBtn.classList.remove('eating');
    }, 400);
    
    // æ›´æ–°åˆ†æ•°
    currentScore += ball.score;
    totalBalls++;
    scoreDisplay.textContent = currentScore;
    ballCountDisplay.textContent = `(${totalBalls}/${TARGET_SCORE})`;
    
    // è¾¾åˆ°ç›®æ ‡åˆ†æ•°
    if (currentScore >= TARGET_SCORE && totalBalls >= 8) {
      setTimeout(() => {
        giftBtn.classList.add('satisfied');
        setTimeout(() => showLotteryOption(), 1000);
      }, 500);
    }
  }
}

function showLotteryOption() {
  clearInterval(walkTimer);
  dot.style.display = "none";
  balls.forEach(b => b.element && b.element.remove());
  balls = [];
  
  giftBtn.classList.add('gift-transform');
  
  setTimeout(() => {
    fireworkBurst(centerX, centerY);
    AudioManager.playSound('promoAppear');
    
    // æ˜¾ç¤ºæŠ½å¥–é€‰é¡¹
    setTimeout(() => showLottery(), 300);
  }, 1500);
}

function fireworkBurst(x, y) {
  const particles = [];
  const colors = ['#FF3B3F', '#FFD700', '#32CD32', '#1E90FF', '#FF69B4', '#FFA500'];
  
  for (let i = 0; i < 100; i++) {
    const angle = Math.random() * 2 * Math.PI;
    const speed = 2 + Math.random() * 5;
    const size = 2 + Math.random() * 4;
    particles.push({
      x, y,
      dx: Math.cos(angle) * speed,
      dy: Math.sin(angle) * speed,
      color: colors[Math.floor(Math.random() * colors.length)],
      size,
      alpha: 1
    });
  }
  
  let frames = 0;
  function animate() {
    frames++;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      p.x += p.dx;
      p.y += p.dy;
      p.dy += 0.08;
      p.alpha *= 0.97;
      const c = parseInt(p.color.slice(1), 16);
      const rgb = `${(c >> 16) & 255}, ${(c >> 8) & 255}, ${c & 255}`;
      ctx.fillStyle = `rgba(${rgb}, ${p.alpha})`;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, 2 * Math.PI);
      ctx.fill();
    });
    if (frames < 60) requestAnimationFrame(animate);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  animate();
}

promoCard.onclick = () => window.location.href = "https://example.com";

window.addEventListener('resize', () => {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
});
</script>

<!-- PWA Service Worker æ³¨å†Œ -->
<script>
// æ³¨å†ŒService Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(registration => {
        console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
      })
      .catch(error => {
        console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
      });
  });
}

// æ£€æµ‹æ˜¯å¦å¯ä»¥å®‰è£…PWA
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  // é˜»æ­¢é»˜è®¤æç¤º
  e.preventDefault();
  // ä¿å­˜äº‹ä»¶ï¼Œä»¥ä¾¿ç¨åè§¦å‘
  deferredPrompt = e;
  console.log('PWAå¯ä»¥å®‰è£…');
});

// ç›‘å¬å®‰è£…æˆåŠŸ
window.addEventListener('appinstalled', () => {
  console.log('PWAå®‰è£…æˆåŠŸï¼');
  deferredPrompt = null;
});
</script>

</body>
</html>
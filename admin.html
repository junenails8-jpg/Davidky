<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEW PROUD NAILS - ç®¡ç†åå°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    /* ç™»å½•é¡µé¢ */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-title {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .login-input {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    /* ä¸»ç•Œé¢ */
    .admin-container {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
    }

    .admin-container.active {
      display: block;
    }

    .admin-header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .admin-title {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logout-btn {
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: #d32f2f;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ç­›é€‰æ  */
    .filter-bar {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .filter-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* é¢„çº¦åˆ—è¡¨ */
    .bookings-container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .bookings-table {
      width: 100%;
      border-collapse: collapse;
    }

    .bookings-table th {
      background: #f5f5f5;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
    }

    .bookings-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .bookings-table tr:hover {
      background: #f9f9f9;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    .action-btn {
      padding: 6px 12px;
      margin: 0 3px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .btn-confirm {
      background: #4CAF50;
      color: white;
    }

    .btn-complete {
      background: #2196F3;
      color: white;
    }

    .btn-cancel {
      background: #f44336;
      color: white;
    }

    .btn-delete {
      background: #9e9e9e;
      color: white;
    }

    .action-btn:hover {
      opacity: 0.8;
    }

    .no-data {
      text-align: center;
      padding: 50px;
      color: #999;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #667eea;
      font-size: 18px;
    }

    /* æ‰‹æœºé€‚é… */
    @media (max-width: 768px) {
      .filter-group {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-btn,
      .search-input {
        width: 100%;
      }

      .bookings-table {
        display: block;
        overflow-x: auto;
      }

      .admin-header {
        flex-direction: column;
        gap: 15px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* åˆ·æ–°æŒ‰é’® */
    .refresh-btn {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }

    .refresh-btn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>

  <!-- ç™»å½•é¡µé¢ -->
  <div class="login-container" id="loginContainer">
    <div class="login-title">NEW PROUD NAILS</div>
    <div style="text-align: center; margin-bottom: 30px; color: #666;">ç®¡ç†å‘˜ç™»å½•</div>
    <input type="password" id="adminPassword" class="login-input" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " autofocus>
    <button class="login-btn" onclick="login()">ç™»å½•</button>
    <div id="loginError" style="color: #f44336; text-align: center; margin-top: 15px; font-size: 14px;"></div>
  </div>

  <!-- ç®¡ç†åå° -->
  <div class="admin-container" id="adminContainer">
    <!-- å¤´éƒ¨ -->
    <div class="admin-header">
      <div class="admin-title">ğŸ’… é¢„çº¦ç®¡ç†ç³»ç»Ÿ</div>
      <div>
        <button class="refresh-btn" onclick="loadBookings()">ğŸ”„ åˆ·æ–°</button>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="statTotal">0</div>
        <div class="stat-label">æ€»é¢„çº¦æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statToday">0</div>
        <div class="stat-label">ä»Šæ—¥é¢„çº¦</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statPending">0</div>
        <div class="stat-label">å¾…ç¡®è®¤</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statConfirmed">0</div>
        <div class="stat-label">å·²ç¡®è®¤</div>
      </div>
    </div>

    <!-- ç­›é€‰æ  -->
    <div class="filter-bar">
      <div class="filter-group">
        <button class="filter-btn active" data-filter="all" onclick="filterByStatus('all')">å…¨éƒ¨</button>
        <button class="filter-btn" data-filter="pending" onclick="filterByStatus('pending')">å¾…ç¡®è®¤</button>
        <button class="filter-btn" data-filter="confirmed" onclick="filterByStatus('confirmed')">å·²ç¡®è®¤</button>
        <button class="filter-btn" data-filter="completed" onclick="filterByStatus('completed')">å·²å®Œæˆ</button>
        <button class="filter-btn" data-filter="cancelled" onclick="filterByStatus('cancelled')">å·²å–æ¶ˆ</button>
        <input type="search" class="search-input" id="searchInput" placeholder="ğŸ” æœç´¢å§“åæˆ–ç”µè¯..." oninput="searchBookings()">
      </div>
    </div>

    <!-- é¢„çº¦åˆ—è¡¨ -->
    <div class="bookings-container">
      <div id="loadingIndicator" class="loading">æ­£åœ¨åŠ è½½é¢„çº¦æ•°æ®...</div>
      <table class="bookings-table" id="bookingsTable" style="display: none;">
        <thead>
          <tr>
            <th>é¢„çº¦æ—¶é—´</th>
            <th>å®¢æˆ·å§“å</th>
            <th>è”ç³»ç”µè¯</th>
            <th>æœåŠ¡é¡¹ç›®</th>
            <th>æŠ€å¸ˆ</th>
            <th>çŠ¶æ€</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="bookingsBody">
        </tbody>
      </table>
      <div id="noDataMessage" class="no-data" style="display: none;">æš‚æ— é¢„çº¦æ•°æ®</div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ==================== é…ç½® ====================
    const ADMIN_PASSWORD = 'mangodavid5678'; // è¯·ä¿®æ”¹ä¸ºæ‚¨çš„ç®¡ç†å‘˜å¯†ç ï¼
    const SUPABASE_URL = 'https://rlkzcohocatggszmlewj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsa3pjb2hvY2F0Z2dzem1sZXdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzM5OTIsImV4cCI6MjA4NTgwOTk5Mn0._toXOopqDriCFc5HXoP5pCKXDi4G7JI7KgJvrQBOj0I';

    // åˆå§‹åŒ– Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // å…¨å±€å˜é‡
    let allBookings = [];
    let currentFilter = 'all';

    // ==================== ç™»å½•åŠŸèƒ½ ====================
    function login() {
      const password = document.getElementById('adminPassword').value;
      const errorEl = document.getElementById('loginError');

      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminLoggedIn', 'true');
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('adminContainer').classList.add('active');
        loadBookings();
      } else {
        errorEl.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
        document.getElementById('adminPassword').value = '';
      }
    }

    function logout() {
      sessionStorage.removeItem('adminLoggedIn');
      document.getElementById('loginContainer').style.display = 'block';
      document.getElementById('adminContainer').classList.remove('active');
      document.getElementById('adminPassword').value = '';
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (sessionStorage.getItem('adminLoggedIn') === 'true') {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('adminContainer').classList.add('active');
      loadBookings();
    }

    // å›è½¦ç™»å½•
    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });

    // ==================== åŠ è½½é¢„çº¦æ•°æ® ====================
    async function loadBookings() {
      const loading = document.getElementById('loadingIndicator');
      const table = document.getElementById('bookingsTable');
      const noData = document.getElementById('noDataMessage');

      loading.style.display = 'block';
      table.style.display = 'none';
      noData.style.display = 'none';

      try {
        const { data, error } = await supabase
          .from('bookings')
          .select('*')
          .order('booking_time', { ascending: false });

        if (error) throw error;

        allBookings = data || [];
        updateStats();
        renderBookings(allBookings);

        loading.style.display = 'none';
        if (allBookings.length > 0) {
          table.style.display = 'table';
        } else {
          noData.style.display = 'block';
        }
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        loading.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
      }
    }

    // ==================== æ¸²æŸ“é¢„çº¦åˆ—è¡¨ ====================
    function renderBookings(bookings) {
      const tbody = document.getElementById('bookingsBody');
      tbody.innerHTML = '';

      bookings.forEach(booking => {
        const tr = document.createElement('tr');
        const bookingDate = new Date(booking.booking_time);
        
        tr.innerHTML = `
          <td>${formatDateTime(bookingDate)}</td>
          <td><strong>${booking.customer_name}</strong></td>
          <td><a href="tel:${booking.customer_phone}">${booking.customer_phone}</a></td>
          <td>${booking.service_name}</td>
          <td>${booking.staff_name}</td>
          <td><span class="status-badge status-${booking.status}">${getStatusText(booking.status)}</span></td>
          <td>${booking.notes || '-'}</td>
          <td>
            ${booking.status === 'pending' ? `<button class="action-btn btn-confirm" onclick="updateStatus('${booking.id}', 'confirmed')">ç¡®è®¤</button>` : ''}
            ${booking.status === 'confirmed' ? `<button class="action-btn btn-complete" onclick="updateStatus('${booking.id}', 'completed')">å®Œæˆ</button>` : ''}
            ${booking.status !== 'cancelled' ? `<button class="action-btn btn-cancel" onclick="updateStatus('${booking.id}', 'cancelled')">å–æ¶ˆ</button>` : ''}
            <button class="action-btn btn-delete" onclick="deleteBooking('${booking.id}')">åˆ é™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ==================== æ›´æ–°ç»Ÿè®¡ ====================
    function updateStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const todayBookings = allBookings.filter(b => {
        const bookingDate = new Date(b.booking_time);
        bookingDate.setHours(0, 0, 0, 0);
        return bookingDate.getTime() === today.getTime();
      });

      const pendingCount = allBookings.filter(b => b.status === 'pending').length;
      const confirmedCount = allBookings.filter(b => b.status === 'confirmed').length;

      document.getElementById('statTotal').textContent = allBookings.length;
      document.getElementById('statToday').textContent = todayBookings.length;
      document.getElementById('statPending').textContent = pendingCount;
      document.getElementById('statConfirmed').textContent = confirmedCount;
    }

    // ==================== ç­›é€‰åŠŸèƒ½ ====================
    function filterByStatus(status) {
      currentFilter = status;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === status) {
          btn.classList.add('active');
        }
      });

      // ç­›é€‰æ•°æ®
      let filtered = allBookings;
      if (status !== 'all') {
        filtered = allBookings.filter(b => b.status === status);
      }

      renderBookings(filtered);
    }

    // ==================== æœç´¢åŠŸèƒ½ ====================
    function searchBookings() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = allBookings;
      if (currentFilter !== 'all') {
        filtered = filtered.filter(b => b.status === currentFilter);
      }

      if (keyword) {
        filtered = filtered.filter(b => 
          b.customer_name.toLowerCase().includes(keyword) ||
          b.customer_phone.includes(keyword)
        );
      }

      renderBookings(filtered);
    }

    // ==================== æ›´æ–°çŠ¶æ€ ====================
    async function updateStatus(bookingId, newStatus) {
      if (!confirm(`ç¡®å®šè¦å°†é¢„çº¦çŠ¶æ€æ›´æ”¹ä¸º"${getStatusText(newStatus)}"å—ï¼Ÿ`)) return;

      try {
        const { error } = await supabase
          .from('bookings')
          .update({ status: newStatus })
          .eq('id', bookingId);

        if (error) throw error;

        alert('çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
        loadBookings();
      } catch (error) {
        console.error('æ›´æ–°å¤±è´¥:', error);
        alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // ==================== åˆ é™¤é¢„çº¦ ====================
    async function deleteBooking(bookingId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é¢„çº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

      try {
        const { error } = await supabase
          .from('bookings')
          .delete()
          .eq('id', bookingId);

        if (error) throw error;

        alert('åˆ é™¤æˆåŠŸï¼');
        loadBookings();
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // ==================== è¾…åŠ©å‡½æ•° ====================
    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function getStatusText(status) {
      const statusMap = {
        'pending': 'å¾…ç¡®è®¤',
        'confirmed': 'å·²ç¡®è®¤',
        'completed': 'å·²å®Œæˆ',
        'cancelled': 'å·²å–æ¶ˆ'
      };
      return statusMap[status] || status;
    }
  </script>

</body>
</html>
